-- WARNING: This procedure requires the Analytics Toolbox and assumes it will be located
-- at the following path: carto-un.carto. If you want to deploy and
-- run it in a different location, you will need to update the code accordingly.
CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_5ebd73ccb9b5d54e`(
)
BEGIN
  /*
   {"versionId":"e8132f1a250e6018","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"title\":\"(9/) GeoPython25 - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"description\":\"\",\"nodes\":[{\"id\":\"456bd2d5-3457-4ecc-9093-6bded8c4cf04\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings\",\"name\":\"ReadTable\",\"size\":14295251,\"type\":\"table\",\"label\":\"CHI_boundary_311_vacant_buildings\",\"nrows\":65119,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"SERVICE REQUEST TYPE\",\"type\":\"string\"},{\"name\":\"SERVICE REQUEST NUMBER\",\"type\":\"string\"},{\"name\":\"DATE SERVICE REQUEST WAS RECEIVED\",\"type\":\"string\"},{\"name\":\"LOCATION OF BUILDING ON THE LOT - IF GARAGE CHANGE TYPE CODE TO BGD-\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING DANGEROUS OR HAZARDOUS\",\"type\":\"number\"},{\"name\":\"IS BUILDING OPEN OR BOARDED\",\"type\":\"string\"},{\"name\":\"IF THE BUILDING IS OPEN WHERE IS THE ENTRY POINT\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING CURRENTLY VACANT OR OCCUPIED\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING VACANT DUE TO FIRE\",\"type\":\"number\"},{\"name\":\"ANY PEOPLE USING PROPERTY - HOMELESS CHILDEN GANGS-\",\"type\":\"number\"},{\"name\":\"ADDRESS STREET NUMBER\",\"type\":\"number\"},{\"name\":\"ADDRESS STREET DIRECTION\",\"type\":\"string\"},{\"name\":\"ADDRESS STREET NAME\",\"type\":\"string\"},{\"name\":\"ADDRESS STREET SUFFIX\",\"type\":\"string\"},{\"name\":\"ZIP CODE\",\"type\":\"number\"},{\"name\":\"X COORDINATE\",\"type\":\"number\"},{\"name\":\"Y COORDINATE\",\"type\":\"number\"},{\"name\":\"Ward\",\"type\":\"number\"},{\"name\":\"Police District\",\"type\":\"number\"},{\"name\":\"Community Area\",\"type\":\"number\"},{\"name\":\"LATITUDE\",\"type\":\"number\"},{\"name\":\"LONGITUDE\",\"type\":\"number\"},{\"name\":\"Location\",\"type\":\"string\"}],\"enriched\":true,\"provider\":\"bigquery\",\"tableRegion\":\"US\",\"lastModified\":1726601816252,\"originalSchema\":[{\"name\":\"SERVICE REQUEST TYPE\",\"type\":\"STRING\"},{\"name\":\"SERVICE REQUEST NUMBER\",\"type\":\"STRING\"},{\"name\":\"DATE SERVICE REQUEST WAS RECEIVED\",\"type\":\"STRING\"},{\"name\":\"LOCATION OF BUILDING ON THE LOT - IF GARAGE CHANGE TYPE CODE TO BGD-\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING DANGEROUS OR HAZARDOUS\",\"type\":\"FLOAT\"},{\"name\":\"IS BUILDING OPEN OR BOARDED\",\"type\":\"STRING\"},{\"name\":\"IF THE BUILDING IS OPEN WHERE IS THE ENTRY POINT\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING CURRENTLY VACANT OR OCCUPIED\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING VACANT DUE TO FIRE\",\"type\":\"FLOAT\"},{\"name\":\"ANY PEOPLE USING PROPERTY - HOMELESS CHILDEN GANGS-\",\"type\":\"FLOAT\"},{\"name\":\"ADDRESS STREET NUMBER\",\"type\":\"FLOAT\"},{\"name\":\"ADDRESS STREET DIRECTION\",\"type\":\"STRING\"},{\"name\":\"ADDRESS STREET NAME\",\"type\":\"STRING\"},{\"name\":\"ADDRESS STREET SUFFIX\",\"type\":\"STRING\"},{\"name\":\"ZIP CODE\",\"type\":\"FLOAT\"},{\"name\":\"X COORDINATE\",\"type\":\"FLOAT\"},{\"name\":\"Y COORDINATE\",\"type\":\"FLOAT\"},{\"name\":\"Ward\",\"type\":\"FLOAT\"},{\"name\":\"Police District\",\"type\":\"FLOAT\"},{\"name\":\"Community Area\",\"type\":\"FLOAT\"},{\"name\":\"LATITUDE\",\"type\":\"FLOAT\"},{\"name\":\"LONGITUDE\",\"type\":\"FLOAT\"},{\"name\":\"Location\",\"type\":\"STRING\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-288,\"y\":480},\"selected\":false,\"positionAbsolute\":{\"x\":-304,\"y\":448}},{\"id\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings\",\"name\":\"ReadTable\",\"size\":158332008,\"type\":\"table\",\"label\":\"CHI_boundary_osm_buildings\",\"nrows\":813845,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"id\",\"type\":\"number\"},{\"name\":\"geom\",\"type\":\"geometry\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"geom\",\"tableRegion\":\"US\",\"lastModified\":1726675350501,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":false}],\"actionAvailable\":{\"msg\":\"<b>This table isn't optimized.</b> Creating a cluster based on geospatial data may improve performance.\",\"type\":\"createTable\",\"query\":\"CREATE TABLE {newTableName} CLUSTER BY geom AS SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings`\"}},\"originalSchema\":[{\"name\":\"id\",\"type\":\"INTEGER\"},{\"name\":\"geom\",\"type\":\"GEOGRAPHY\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-288,\"y\":624},\"selected\":false,\"positionAbsolute\":{\"x\":-304,\"y\":656}},{\"id\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"data\":{\"name\":\"native.geogpoint\",\"label\":\"ST GeogPoint\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"lat\",\"type\":\"Column\",\"title\":\"Latitude column\",\"parent\":\"source\",\"dataType\":[\"number\",\"string\"],\"description\":\"Latitude column\",\"value\":\"LATITUDE\"},{\"name\":\"lon\",\"type\":\"Column\",\"title\":\"Longitude column\",\"parent\":\"source\",\"dataType\":[\"number\",\"string\"],\"description\":\"Longitude column\",\"value\":\"LONGITUDE\"},{\"name\":\"optimizationcol\",\"value\":\"geom\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":576,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":736,\"y\":368}},{\"id\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"data\":{\"name\":\"native.distance\",\"label\":\"Distance to nearest\",\"inputs\":[{\"name\":\"main\",\"type\":\"Table\",\"title\":\"Main table\",\"description\":\"Main table\"},{\"name\":\"secondary\",\"type\":\"Table\",\"title\":\"Secondary table\",\"description\":\"Secondary table\"},{\"name\":\"geomain\",\"type\":\"Column\",\"title\":\"Geo column in main table\",\"parent\":\"main\",\"dataType\":[\"geography\"],\"description\":\"Geo column in main table\",\"value\":\"geom\"},{\"name\":\"geosecondary\",\"type\":\"Column\",\"title\":\"Geo column in secondary table\",\"parent\":\"secondary\",\"dataType\":[\"geography\"],\"description\":\"Geo column in secondary table\",\"value\":\"geom\"},{\"name\":\"idmain\",\"type\":\"Column\",\"title\":\"Id column in main table\",\"parent\":\"main\",\"description\":\"Id column in main table\",\"value\":\"ID\"},{\"name\":\"idsecondary\",\"type\":\"Column\",\"title\":\"Id column in secondary table\",\"parent\":\"secondary\",\"description\":\"Id column in secondary table\",\"value\":\"id\"},{\"name\":\"radius\",\"type\":\"Number\",\"title\":\"Radius\",\"min\":0,\"description\":\"Radius\",\"value\":100},{\"name\":\"units\",\"type\":\"Selection\",\"title\":\"Units\",\"options\":[\"Meters\",\"Miles\"],\"default\":\"Meters\",\"description\":\"Units\",\"value\":\"Meters\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":752,\"y\":480},\"selected\":false,\"positionAbsolute\":{\"x\":976,\"y\":640}},{\"id\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"data\":{\"name\":\"native.select\",\"label\":\"Select\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"select\",\"type\":\"StringSql\",\"title\":\"SELECT statement\",\"placeholder\":\"E.g.: *, distance_in_km * 1000 AS distance_in_meters\",\"allowExpressions\":false,\"description\":\"SELECT statement\",\"value\":\"ID, LATITUDE, LONGITUDE\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":336,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":416,\"y\":416}},{\"id\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"data\":{\"name\":\"native.where\",\"label\":\"Where\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"expression\",\"type\":\"StringSql\",\"title\":\"Filter expression\",\"placeholder\":\"E.g.: area > 1000 AND area < 3000\",\"description\":\"Filter expression\",\"value\":\"LATITUDE IS NOT NULL AND LONGITUDE IS NOT NULL\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":448,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":560,\"y\":416}},{\"id\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"data\":{\"name\":\"native.selectexpression\",\"label\":\"Create Column\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"String\",\"title\":\"Name for new column\",\"placeholder\":\"E.g.: distance_in_meters\",\"validation\":\"^[a-zA-Z_][a-zA-Z0-9_]*$\",\"allowExpressions\":false,\"description\":\"Name for new column\",\"value\":\"Location_ID\"},{\"name\":\"expression\",\"type\":\"StringSql\",\"title\":\"Expression\",\"placeholder\":\"E.g.: distance_in_km * 1000\",\"description\":\"Expression\",\"value\":\"ROW_NUMBER() OVER(PARTITION BY Location)\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":64,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":96,\"y\":448}},{\"id\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"data\":{\"name\":\"native.wheresimplified\",\"label\":\"Simple Filter\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"dataType\":[\"string\",\"number\",\"date\",\"datetime\",\"time\",\"timestamp\",\"boolean\"],\"description\":\"Column\",\"value\":\"Location_ID\"},{\"name\":\"operator\",\"type\":\"Selection\",\"title\":\"Operator\",\"options\":[\"equal to\",\"not equal\",\"less than\",\"greater than\",\"equal or less than\",\"equal or greater than\"],\"description\":\"Operator\",\"value\":\"equal to\"},{\"name\":\"value\",\"type\":\"String\",\"title\":\"Value\",\"description\":\"Value\",\"value\":\"1\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":208,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":256,\"y\":448}},{\"id\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"data\":{\"name\":\"native.join\",\"label\":\"Join\",\"inputs\":[{\"name\":\"maintable\",\"type\":\"Table\",\"title\":\"Main table\",\"description\":\"Main table\"},{\"name\":\"secondarytable\",\"type\":\"Table\",\"title\":\"Secondary table\",\"description\":\"Secondary table\"},{\"name\":\"maincolumn\",\"type\":\"Column\",\"title\":\"Column in main table\",\"parent\":\"maintable\",\"dataType\":[\"boolean\",\"date\",\"datetime\",\"time\",\"timestamp\",\"number\",\"string\"],\"description\":\"Column in main table\",\"value\":\"nearest_id\"},{\"name\":\"secondarycolumn\",\"type\":\"Column\",\"title\":\"Column in secondary table\",\"parent\":\"secondarytable\",\"dataType\":[\"boolean\",\"date\",\"datetime\",\"time\",\"timestamp\",\"number\",\"string\"],\"description\":\"Column in secondary table\",\"value\":\"id\"},{\"name\":\"jointype\",\"type\":\"Selection\",\"title\":\"Join type\",\"options\":[\"Inner\",\"Left\",\"Right\",\"Full outer\"],\"default\":\"Inner\",\"description\":\"Join type\",\"value\":\"Inner\"},{\"name\":\"optimizationcol\"}],\"version\":\"1.2\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":896,\"y\":672},\"selected\":false,\"positionAbsolute\":{\"x\":1216,\"y\":848}},{\"id\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"data\":{\"name\":\"native.dropcolumn\",\"label\":\"Drop Columns\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Columns to drop\",\"parent\":\"source\",\"mode\":\"multiple\",\"noDefault\":true,\"description\":\"Columns to drop\",\"value\":[\"id_joined\",\"geom\"]},{\"name\":\"optimizationcol\",\"value\":\"geom_joined\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1024,\"y\":672},\"selected\":false,\"positionAbsolute\":{\"x\":1376,\"y\":848}},{\"id\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"data\":{\"name\":\"native.renamecolumn\",\"label\":\"Rename Column\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column to rename\",\"parent\":\"source\",\"dataType\":[\"boolean\",\"geography\",\"number\",\"string\"],\"description\":\"Column to rename\",\"value\":\"geom_joined\"},{\"name\":\"newname\",\"type\":\"String\",\"title\":\"New column name\",\"validation\":\"^[a-zA-Z_][a-zA-Z0-9_]*$\",\"allowExpressions\":false,\"description\":\"New column name\",\"value\":\"geom\"},{\"name\":\"optimizationcol\",\"value\":\"geom\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1152,\"y\":672},\"selected\":false,\"positionAbsolute\":{\"x\":1568,\"y\":848}},{\"id\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"data\":{\"name\":\"native.customsql\",\"label\":\"Custom SQL Select\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT a.geom\\nFROM `$a`a\\nJOIN `$b`b\\nON ST_INTERSECTS(b.h3_geo, a.geom)\"},{\"name\":\"optimizationcol\"}],\"version\":\"2.0.0\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1280,\"y\":752},\"selected\":false,\"positionAbsolute\":{\"x\":1760,\"y\":864}},{\"id\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"data\":{\"name\":\"native.h3boundary\",\"label\":\"H3 Boundary\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"h3col\",\"type\":\"Column\",\"title\":\"H3 column\",\"parent\":\"source\",\"placeholder\":\"h3\",\"dataType\":[\"string\"],\"description\":\"H3 column\",\"value\":\"h3\"},{\"name\":\"optimizationcol\",\"value\":\"h3_geo\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":96,\"y\":720},\"selected\":false,\"positionAbsolute\":{\"x\":112,\"y\":896}},{\"id\":\"a6bd614b-be85-4c52-b230-9199ad01fcee\",\"data\":{\"name\":\"native.saveastable\",\"label\":\"Save as Table\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"geom\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1600,\"y\":544},\"selected\":false,\"positionAbsolute\":{\"x\":2048,\"y\":864}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":496,\"height\":607.998,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":-528.007,\"y\":288}},\"type\":\"note\",\"width\":624,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-528,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":-656,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":464,\"height\":127.99600000000001,\"inputs\":[],\"markdown\":\"---\\nlabel: Anomalous space-time region\\n---\\n##\",\"position\":{\"x\":-512,\"y\":736}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-512,\"y\":736},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":800}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889-1726833430111\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":463.999,\"height\":128,\"inputs\":[],\"markdown\":\"---\\nlabel: OSM buildings\\n---\\n##\",\"position\":{\"x\":-512.005,\"y\":592}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-512,\"y\":592},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":576}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889-1726833430111-1726833449150\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":463.999,\"height\":224,\"inputs\":[],\"markdown\":\"---\\nlabel: 311  vacant buildings 2001 - 2017\\n---\\n311 calls for open and vacant buildings [reported](https://www.chicago.gov/city/en/depts/bldgs/dataset/vacant_and_abandonedbuildingsservicerequests.html ) to the City of Chicago between January 1, 2010 and December 2018.\",\"position\":{\"x\":-512.001,\"y\":352}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":-512,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":352}},{\"id\":\"251263f0-60ba-4468-b2da-caa0155aeef4\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":335.997,\"height\":607.997,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save results to a table\",\"position\":{\"x\":1456,\"y\":288}},\"type\":\"note\",\"width\":336,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1456,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":1904,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1456,\"height\":607.997,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Join data sources\",\"position\":{\"x\":-16,\"y\":288}},\"type\":\"note\",\"width\":1904,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-16,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":-16,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186-1726835244460\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1088,\"height\":272,\"inputs\":[],\"markdown\":\"---\\nlabel: Extract point geometries and find the nearest building (within 100 m)\\n---\",\"position\":{\"x\":0,\"y\":352}},\"type\":\"note\",\"width\":1088,\"height\":400,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":0,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":0,\"y\":352}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186-1726835244460-1726835578127\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1423.99,\"height\":239.99699999999999,\"inputs\":[],\"markdown\":\"---\\nlabel: Find the vacant properties within the detected anomalous region\\n---\",\"position\":{\"x\":0,\"y\":640}},\"type\":\"note\",\"width\":1872,\"height\":240,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":0,\"y\":640},\"selected\":false,\"positionAbsolute\":{\"x\":0,\"y\":768}},{\"id\":\"e072bf18-5573-4e02-8873-3a6a53a95874\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\",\"name\":\"ReadTable\",\"size\":2255,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_st_anomalies_unnested\",\"nrows\":55,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"predicted_counts\",\"type\":\"number\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1739894301278,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":false}],\"actionAvailable\":{\"msg\":\"<b>This table isn't optimized.</b> Creating a cluster based on geospatial data may improve performance.\",\"type\":\"createTable\",\"query\":\"CREATE TABLE {newTableName} CLUSTER BY h3 AS SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`\"}},\"originalSchema\":[{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"predicted_counts\",\"type\":\"INTEGER\"}]},\"type\":\"source\",\"zIndex\":2,\"position\":{\"x\":-288,\"y\":768},\"selected\":false}],\"edges\":[{\"id\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18result-335e6ad2-6862-485e-9c3f-4acf8b3bed19main\",\"source\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"target\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"main\",\"animated\":false},{\"id\":\"reactflow__edge-fe63978b-c663-4be1-bcee-94fa88942b11out-335e6ad2-6862-485e-9c3f-4acf8b3bed19secondary\",\"source\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"target\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"sourceHandle\":\"out\",\"targetHandle\":\"secondary\",\"animated\":false},{\"id\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7result-79561f1c-5e64-4c1c-82f7-fa75ac682176source\",\"source\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"target\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-79561f1c-5e64-4c1c-82f7-fa75ac682176match-14197a14-59bf-4e50-a0c2-19503ca4bb18source\",\"source\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"target\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"sourceHandle\":\"match\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5result-1e310368-3313-4d5a-a086-de1417a1077fsource\",\"source\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"target\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-1e310368-3313-4d5a-a086-de1417a1077fmatch-0e6789ec-651b-4567-8d5b-d5c6c143e8d7table\",\"source\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"target\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"sourceHandle\":\"match\",\"targetHandle\":\"table\",\"animated\":false},{\"id\":\"reactflow__edge-335e6ad2-6862-485e-9c3f-4acf8b3bed19result-61b36200-c5bb-40a6-8009-f34cd7a7c0b1maintable\",\"source\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"target\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"sourceHandle\":\"result\",\"targetHandle\":\"maintable\",\"animated\":false},{\"id\":\"reactflow__edge-fe63978b-c663-4be1-bcee-94fa88942b11out-61b36200-c5bb-40a6-8009-f34cd7a7c0b1secondarytable\",\"source\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"target\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"sourceHandle\":\"out\",\"targetHandle\":\"secondarytable\",\"animated\":false},{\"id\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1result-95bdb371-bbb7-4021-8c87-9564c7140da8source\",\"source\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"target\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"95bdb371-bbb7-4021-8c87-9564c7140da8result-18276d66-d586-4b76-ac47-e602b3885d3bsource\",\"source\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"target\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-18276d66-d586-4b76-ac47-e602b3885d3bresult-fcad1fdd-af00-46ae-8ab8-dcd023780dffsourcea\",\"source\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"target\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\",\"animated\":false},{\"id\":\"reactflow__edge-456bd2d5-3457-4ecc-9093-6bded8c4cf04out-7746af6f-3ea9-4e43-93b5-9e99afdae2a5source\",\"source\":\"456bd2d5-3457-4ecc-9093-6bded8c4cf04\",\"target\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"sourceHandle\":\"out\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dffresult-a6bd614b-be85-4c52-b230-9199ad01fceesource\",\"source\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"target\":\"a6bd614b-be85-4c52-b230-9199ad01fcee\",\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-5061c491-312a-4100-a2ac-c8d65bab634eresult-fcad1fdd-af00-46ae-8ab8-dcd023780dffsourceb\",\"source\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"target\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\",\"animated\":false},{\"id\":\"9733172e-a195-44fc-8857-95eed3bdddec\",\"type\":\"default\",\"source\":\"e072bf18-5573-4e02-8873-3a6a53a95874\",\"target\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"sourceHandle\":\"out\",\"targetHandle\":\"source\",\"animated\":false}],\"variables\":null,\"procedure\":{},\"schedule\":{},\"viewport\":{\"x\":448.63904132631836,\"y\":-24.344896311566004,\"zoom\":0.6278774480028474},\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\",\"useCache\":false}"}
  */
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_3cb5ae20bca68cd5_result`
  AS
    SELECT *,
      ROW_NUMBER() OVER(PARTITION BY Location) AS Location_ID
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_de4e9aa1c0708fdf_match`
  AS
    SELECT *
    FROM `WORKFLOW_5ebd73ccb9b5d54e_3cb5ae20bca68cd5_result`
    WHERE
      Location_ID = 1;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_cb5896e16c01ec5e_result`
  AS
    SELECT ID, LATITUDE, LONGITUDE
    FROM `WORKFLOW_5ebd73ccb9b5d54e_de4e9aa1c0708fdf_match`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_66e836b4ded6e600_match`
  AS
    SELECT *
    FROM `WORKFLOW_5ebd73ccb9b5d54e_cb5896e16c01ec5e_result`
    WHERE LATITUDE IS NOT NULL AND LONGITUDE IS NOT NULL;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_fc83b9f2e5563960_result`
  AS
    SELECT ST_GEOGPOINT(
      CAST(LONGITUDE as FLOAT64),
      CAST(LATITUDE as FLOAT64)
    ) AS  geom, *
    FROM `WORKFLOW_5ebd73ccb9b5d54e_66e836b4ded6e600_match`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_61ce6f0c074ea0b7_result`
  AS
    WITH nearest AS (
      SELECT a.ID AS main_id,
          ARRAY_AGG(
              STRUCT(
                  b.id AS nearest_id,
                  ST_DISTANCE(
                      a.geom,
                      b.geom
                  ) AS nearest_distance
              )
              ORDER BY ST_DISTANCE(
                      a.geom,
                      b.geom
                  )
              LIMIT 1
          ) [ORDINAL(1)] AS nearest
      FROM `WORKFLOW_5ebd73ccb9b5d54e_fc83b9f2e5563960_result` a
          JOIN `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings` b
            ON ST_DWITHIN(
              a.geom,
              b.geom,
              100 
            )
      GROUP BY a.ID
    )
    SELECT a.*,
        n.nearest.nearest_id AS nearest_id,
        n.nearest.nearest_distance  AS nearest_distance
    FROM nearest n
        JOIN `WORKFLOW_5ebd73ccb9b5d54e_fc83b9f2e5563960_result` a
          ON a.ID = n.main_id;
  END;
  BEGIN
  DECLARE alias STRING;
  CREATE TABLE `cartodb-on-gcp-datascience.workflows_temp.table_65c572df_6bdc_4f9f_a2a6_7cdf34a42a3a` AS
  SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings`
  WHERE 1=0;
  EXECUTE IMMEDIATE
  '''
    with __alias AS(
      SELECT CONCAT(
        '_joined.', column_name, ' AS ', column_name, '_joined'
      ) col_alias
      FROM `cartodb-on-gcp-datascience.workflows_temp`.INFORMATION_SCHEMA.COLUMNS
    WHERE table_name = 'table_65c572df_6bdc_4f9f_a2a6_7cdf34a42a3a'
    )
    SELECT STRING_AGG(col_alias, ', ')
    FROM __alias
  '''
  INTO alias;
  DROP TABLE `cartodb-on-gcp-datascience.workflows_temp.table_65c572df_6bdc_4f9f_a2a6_7cdf34a42a3a`;
  EXECUTE IMMEDIATE
  REPLACE(
    '''CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_9a244a4055bb9671_result`
    AS
      SELECT
        _main.*,
        %s
      FROM
        `WORKFLOW_5ebd73ccb9b5d54e_61ce6f0c074ea0b7_result` AS _main
      INNER JOIN
        `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings` AS _joined
      ON
        _main.nearest_id = _joined.id''',
    '%s',
    alias
  );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_7cd278e96779daa5_result`
  AS
    SELECT * EXCEPT (id_joined, geom)
    FROM `WORKFLOW_5ebd73ccb9b5d54e_9a244a4055bb9671_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_1c19500733d9a004_result`
  AS
    SELECT * EXCEPT (geom_joined),
      geom_joined AS geom
    FROM `WORKFLOW_5ebd73ccb9b5d54e_7cd278e96779daa5_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_07989689e40ad423_result`
  AS
    SELECT
      `carto-un.carto`.H3_BOUNDARY(
          h3
      ) h3_geo, *
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_5ebd73ccb9b5d54e_0382e6e23e20378b_result`
  AS
    SELECT a.geom
    FROM `WORKFLOW_5ebd73ccb9b5d54e_1c19500733d9a004_result`a
    JOIN `WORKFLOW_5ebd73ccb9b5d54e_07989689e40ad423_result`b
    ON ST_INTERSECTS(b.h3_geo, a.geom);
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings`
  CLUSTER BY geom
  AS
    SELECT * FROM `WORKFLOW_5ebd73ccb9b5d54e_0382e6e23e20378b_result`;
  END;
END;