CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_7bf50b5cfc0b38ae`(
)
BEGIN
  /*
   {"versionId":"95c4cde2bcb919f1","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"title\":\"(7/) GeoPython25 - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"description\":\"\",\"nodes\":[{\"id\":\"f205bded-2345-4729-902e-bf330725e481\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":464,\"height\":543.9970000000001,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":1599.99,\"y\":-64}},\"type\":\"note\",\"width\":512,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1600,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":1552,\"y\":-64}},{\"id\":\"a6239dad-2039-4079-81f1-0ebc6a96248d\",\"data\":{\"name\":\"native.saveastable\",\"label\":\"Save as Table\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"<my-project>.<my-dataset>.CHI_boundary_enriched_w_baselines\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2784,\"y\":176},\"selected\":false,\"positionAbsolute\":{\"x\":3136,\"y\":320}},{\"id\":\"a7c19694-9a93-4059-a569-3253bff0f2f5-1726578426527\",\"data\":{\"name\":\"Note\",\"color\":\"#DCB0F2\",\"genAi\":false,\"label\":\"\",\"width\":544,\"height\":543.9970000000001,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Estimate the expected value of the series conditional on the selected covariates\\n\\nTo estimate the expected crime rate per 1,000 people, we can import a pre-trained model [from GCS using scikit-learn](https://cloud.google.com/bigquery/docs/reference/standard-sql/bigqueryml-syntax-create-onnx). This approach is useful when training and prediction are handled in separate processes (e.g., a data scientist trains the model, while an analyst performs the forecasting) or for specific use cases such as online predictions or predictions based on different data sets.\",\"position\":{\"x\":2080,\"y\":-64}},\"type\":\"note\",\"width\":928,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":2080,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":2080,\"y\":-64}},{\"id\":\"a7c19694-9a93-4059-a569-3253bff0f2f5-1726578426527-1726578437332\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":335.995,\"height\":543.999,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save results to a table\",\"position\":{\"x\":2640,\"y\":-64}},\"type\":\"note\",\"width\":528,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":2640,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":3024,\"y\":-64}},{\"id\":\"c7b53475-4e29-4923-a75c-f8ef8fda3890\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":431.99499999999995,\"height\":175.995,\"inputs\":[],\"markdown\":\"---\\nlabel: Chicago boundary enriched and pre-processed (FAMD) data:\\n---\\n\",\"position\":{\"y\":175.996,\"x\":1616}},\"type\":\"note\",\"width\":480,\"height\":224,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1616,\"y\":128},\"selected\":false,\"positionAbsolute\":{\"x\":1568,\"y\":128}},{\"id\":\"de940c44-4a2a-4399-a502-a544b8d0bd4f\",\"data\":{\"name\":\"importmodel\",\"type\":\"generic\",\"label\":\"Import model\",\"inputs\":[{\"name\":\"model_gcs_uri\",\"title\":\"Model path\",\"description\":\"Google Cloud Storage URI (`gs://`) of the pre-trained ONNX file.\",\"type\":\"String\",\"value\":\"gs://sdsc_workshops/sdsc24_10/onnx_models/model_lr_encode_holiday.onnx\"},{\"name\":\"model_fqn\",\"title\":\"Model FQN\",\"description\":\"Fully-qualified name to save the model to.\",\"type\":\"String\",\"value\":\"<my-project>.<my-dataset>.CHI_onnx_model\"},{\"name\":\"overwrite_model\",\"title\":\"Overwrite model\",\"description\":\"Whether to overwrite the model if it already exists.\",\"type\":\"Boolean\",\"default\":false,\"value\":true}],\"version\":\"1.0.0\"},\"type\":\"generic\",\"zIndex\":2,\"position\":{\"x\":2176,\"y\":208},\"selected\":false},{\"id\":\"9644ad8c-ec5b-46d7-98c8-66b309a85d02\",\"data\":{\"name\":\"predict\",\"type\":\"generic\",\"label\":\"Predict\",\"inputs\":[{\"name\":\"model_table\",\"title\":\"Model\",\"description\":\"The trained model to use.\",\"type\":\"Table\"},{\"name\":\"input_table\",\"title\":\"Input table\",\"description\":\"The input data table.\",\"type\":\"Table\"},{\"name\":\"keep_columns\",\"title\":\"Keep input columns\",\"description\":\"Whether to keep all input columns in the output or not.\",\"type\":\"Boolean\",\"default\":true,\"value\":true},{\"name\":\"id_column\",\"title\":\"ID column\",\"description\":\"Column to use as the unique identifier for the model.\",\"type\":\"Column\",\"parent\":\"input_table\",\"noDefault\":true,\"showIf\":[{\"value\":false,\"parameter\":\"keep_columns\"}]}],\"version\":\"1.0.0\"},\"type\":\"generic\",\"zIndex\":2,\"position\":{\"x\":2336,\"y\":320},\"selected\":false},{\"id\":\"65be8071-1f17-4109-a6c2-0b5755f87593\",\"data\":{\"name\":\"native.select\",\"label\":\"Select\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"select\",\"type\":\"StringSql\",\"title\":\"SELECT statement\",\"placeholder\":\"E.g.: *, distance_in_km * 1000 AS distance_in_meters\",\"allowExpressions\":false,\"description\":\"SELECT statement\",\"value\":\"* EXCEPT(variable), CASE WHEN variable < 0 THEN 0 ELSE variable END AS predicted_counts_ratio,\\nCASE WHEN variable < 0 THEN 0 ELSE CAST(variable / 1000 * total_pop_sum AS INT) END AS predicted_counts\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"zIndex\":2,\"position\":{\"x\":2464,\"y\":208},\"selected\":false},{\"id\":\"f021f5c5-6c66-4cf5-a923-defd93e61055\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags\",\"name\":\"ReadTable\",\"size\":33028470,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_w_lags\",\"nrows\":145348,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"year\",\"type\":\"number\"},{\"name\":\"month\",\"type\":\"number\"},{\"name\":\"total_pop_sum\",\"type\":\"number\"},{\"name\":\"median_age_avg\",\"type\":\"number\"},{\"name\":\"median_rent_avg\",\"type\":\"number\"},{\"name\":\"black_pop_sum\",\"type\":\"number\"},{\"name\":\"hispanic_pop_sum\",\"type\":\"number\"},{\"name\":\"owner_occupied_housing_units_median_value_sum\",\"type\":\"number\"},{\"name\":\"vacant_housing_units_sum\",\"type\":\"number\"},{\"name\":\"housing_units_sum\",\"type\":\"number\"},{\"name\":\"families_with_young_children_sum\",\"type\":\"number\"},{\"name\":\"urbanity_any\",\"type\":\"string\"},{\"name\":\"urbanity_any_ordinal\",\"type\":\"number\"},{\"name\":\"principal_component_1\",\"type\":\"number\"},{\"name\":\"principal_component_2\",\"type\":\"number\"},{\"name\":\"counts_ratio\",\"type\":\"number\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"number\"},{\"name\":\"seasonal_sin\",\"type\":\"number\"},{\"name\":\"seasonal_cos\",\"type\":\"number\"},{\"name\":\"holiday_name\",\"type\":\"string\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1739890577461,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":true}]},\"originalSchema\":[{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"year\",\"type\":\"INTEGER\"},{\"name\":\"month\",\"type\":\"INTEGER\"},{\"name\":\"total_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"median_age_avg\",\"type\":\"FLOAT\"},{\"name\":\"median_rent_avg\",\"type\":\"FLOAT\"},{\"name\":\"black_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"hispanic_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"owner_occupied_housing_units_median_value_sum\",\"type\":\"FLOAT\"},{\"name\":\"vacant_housing_units_sum\",\"type\":\"FLOAT\"},{\"name\":\"housing_units_sum\",\"type\":\"FLOAT\"},{\"name\":\"families_with_young_children_sum\",\"type\":\"FLOAT\"},{\"name\":\"urbanity_any\",\"type\":\"STRING\"},{\"name\":\"urbanity_any_ordinal\",\"type\":\"INTEGER\"},{\"name\":\"principal_component_1\",\"type\":\"FLOAT\"},{\"name\":\"principal_component_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_sin\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_cos\",\"type\":\"FLOAT\"},{\"name\":\"holiday_name\",\"type\":\"STRING\"}]},\"type\":\"source\",\"zIndex\":2,\"position\":{\"x\":1728,\"y\":240},\"selected\":false}],\"edges\":[{\"id\":\"cdb637bf-063f-49c7-b394-8ced7e832ec4\",\"type\":\"default\",\"source\":\"de940c44-4a2a-4399-a502-a544b8d0bd4f\",\"target\":\"9644ad8c-ec5b-46d7-98c8-66b309a85d02\",\"sourceHandle\":\"output_table\",\"targetHandle\":\"model_table\",\"animated\":false},{\"id\":\"35be8780-b381-4ad0-9119-3ded94b3a6c2\",\"type\":\"default\",\"source\":\"9644ad8c-ec5b-46d7-98c8-66b309a85d02\",\"target\":\"65be8071-1f17-4109-a6c2-0b5755f87593\",\"sourceHandle\":\"output_table\",\"targetHandle\":\"table\",\"animated\":false},{\"id\":\"ceaca345-3987-4749-9fe9-31a0c7da567e\",\"type\":\"default\",\"source\":\"65be8071-1f17-4109-a6c2-0b5755f87593\",\"target\":\"a6239dad-2039-4079-81f1-0ebc6a96248d\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"f9f6bd7c-f597-43db-8c0c-729e6e0a1952\",\"source\":\"f021f5c5-6c66-4cf5-a923-defd93e61055\",\"sourceHandle\":\"out\",\"target\":\"9644ad8c-ec5b-46d7-98c8-66b309a85d02\",\"targetHandle\":\"input_table\",\"type\":\"default\",\"animated\":false}],\"variables\":null,\"procedure\":{},\"schedule\":{},\"viewport\":{\"x\":-2038.2669648284127,\"y\":142.66512036968209,\"zoom\":1.2928290575861991},\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\",\"useCache\":false}"}
  */
  BEGIN
  CALL `cartodb-on-gcp-datascience.workflows_temp`.__proc_importmodel_24688603(
    '''gs://sdsc_workshops/sdsc24_10/onnx_models/model_lr_encode_holiday.onnx''',
    '''<my-project>.<my-dataset>.CHI_onnx_model''',
    true,
    'WORKFLOW_7bf50b5cfc0b38ae_70fd64e3d33b572e_output_table',
    false,
    '{}'
  );
  END;
  BEGIN
  CALL `cartodb-on-gcp-datascience.workflows_temp`.__proc_predict_74702755(
    'WORKFLOW_7bf50b5cfc0b38ae_70fd64e3d33b572e_output_table',
    'cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags',
    true,
    null,
    'WORKFLOW_7bf50b5cfc0b38ae_9e4dca363121834a_output_table',
    false,
    '{}'
  );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_7bf50b5cfc0b38ae_a76b7a2e5faea799_result`
  AS
    SELECT * EXCEPT(variable), CASE WHEN variable < 0 THEN 0 ELSE variable END AS predicted_counts_ratio,
    CASE WHEN variable < 0 THEN 0 ELSE CAST(variable / 1000 * total_pop_sum AS INT) END AS predicted_counts
    FROM `WORKFLOW_7bf50b5cfc0b38ae_9e4dca363121834a_output_table`;
  END;
  BEGIN
  DROP TABLE IF EXISTS `<my-project>.<my-dataset>.CHI_boundary_enriched_w_baselines`;
  CREATE TABLE IF NOT EXISTS `<my-project>.<my-dataset>.CHI_boundary_enriched_w_baselines`
  CLUSTER BY h3
  AS
    SELECT * FROM `WORKFLOW_7bf50b5cfc0b38ae_a76b7a2e5faea799_result`;
  END;
END;