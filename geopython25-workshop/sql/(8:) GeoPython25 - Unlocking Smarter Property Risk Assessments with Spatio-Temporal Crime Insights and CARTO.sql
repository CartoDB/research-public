-- WARNING: This procedure requires the Analytics Toolbox and assumes it will be located
-- at the following path: carto-un.carto. If you want to deploy and
-- run it in a different location, you will need to update the code accordingly.
CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_bd8ce2e8cefa706f`(
)
BEGIN
  /*
   {"versionId":"1852884c345b3e71","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"title\":\"(8/) GeoPython25 - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"description\":\"\",\"nodes\":[{\"id\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"data\":{\"name\":\"native.orderby\",\"label\":\"Order by\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Table to order\",\"description\":\"Table to order\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column to order by\",\"dataType\":[\"number\",\"string\",\"date\",\"time\",\"datetime\",\"timestamp\"],\"parent\":\"table\",\"description\":\"Column to order by\",\"value\":\"score\"},{\"name\":\"desc\",\"type\":\"Boolean\",\"title\":\"Use descending order\",\"default\":false,\"description\":\"Use descending order\",\"value\":true},{\"name\":\"columnb\",\"type\":\"Column\",\"title\":\"Optional secondary column to order by\",\"parent\":\"table\",\"dataType\":[\"number\",\"string\",\"date\",\"time\",\"datetime\",\"timestamp\"],\"default\":null,\"optional\":true,\"description\":\"Optional secondary column to order by\"},{\"name\":\"descb\",\"type\":\"Boolean\",\"title\":\"Use descending order in secondary column\",\"default\":false,\"description\":\"Use descending order in secondary column\",\"value\":false}],\"version\":\"1.0.2\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":816,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":864,\"y\":352}},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"data\":{\"name\":\"native.unnest\",\"label\":\"Unnest\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"col\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"description\":\"Column\",\"value\":\"locations\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1360,\"y\":304},\"selected\":false,\"positionAbsolute\":{\"x\":1520,\"y\":224}},{\"id\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"data\":{\"name\":\"native.rownumber\",\"label\":\"Row number\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":928,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":1040,\"y\":352}},{\"id\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"data\":{\"name\":\"native.wheresimplified\",\"label\":\"Simple Filter\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"dataType\":[\"string\",\"number\",\"date\",\"datetime\",\"time\",\"timestamp\",\"boolean\"],\"description\":\"Column\",\"value\":\"row_count\"},{\"name\":\"operator\",\"type\":\"Selection\",\"title\":\"Operator\",\"options\":[\"equal to\",\"not equal\",\"less than\",\"greater than\",\"equal or less than\",\"equal or greater than\"],\"description\":\"Operator\",\"value\":\"equal to\"},{\"name\":\"value\",\"type\":\"String\",\"title\":\"Value\",\"description\":\"Value\",\"value\":\"1\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1072,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":1216,\"y\":352}},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"data\":{\"name\":\"native.unnest\",\"label\":\"Unnest\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"col\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"description\":\"Column\",\"value\":\"times\"},{\"name\":\"optimizationcol\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1488,\"y\":304},\"selected\":false,\"positionAbsolute\":{\"x\":1664,\"y\":224}},{\"id\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"data\":{\"name\":\"native.customsql\",\"label\":\"Custom SQL Select\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT a.h3, a.week, a.counts, a.predicted_counts\\nFROM `$a` a\\nJOIN `$b` b\\nON a.h3 = b.locations_unnested AND a.week = b.times_unnested\"},{\"name\":\"optimizationcol\"}],\"version\":\"2.0.0\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1616,\"y\":224},\"selected\":false,\"positionAbsolute\":{\"x\":1840,\"y\":160}},{\"id\":\"790c9db1-de41-4c50-a0f1-5f559087d964\",\"data\":{\"name\":\"native.saveastable\",\"label\":\"Save as Table\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2240,\"y\":224},\"selected\":false,\"positionAbsolute\":{\"x\":2128,\"y\":160}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":431.997,\"height\":511.99800000000005,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":-432.006,\"y\":-16.004}},\"type\":\"note\",\"width\":496,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-432,\"y\":16},\"selected\":false,\"positionAbsolute\":{\"x\":-496,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1280,\"height\":511.99800000000005,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Detect space-time anomalies\\n\\nTo detect anomalies that affect multiple time series simultaneously, we adopt a [multi-resolution approach]() in which we search over a large and overlapping set of space-time regions, each containing some subset of the data, and find the most significant clusters of anomalous data.\",\"position\":{\"x\":16,\"y\":-16.008}},\"type\":\"note\",\"width\":1408,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":16,\"y\":16},\"selected\":false,\"positionAbsolute\":{\"x\":16,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726831966580\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":656,\"height\":303.99600000000004,\"inputs\":[],\"markdown\":\"---\\nlabel: Call procedure\\n---\\nWe compute a score function that compares the probability that a space-time region _S_ is anomalous compared to some baseline to the probability of no anomalous regions.\",\"position\":{\"x\":64,\"y\":159.998}},\"type\":\"note\",\"width\":736,\"height\":272,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":64,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":64,\"y\":192}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726831966580-1726832000306\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":512,\"height\":303.99600000000004,\"inputs\":[],\"markdown\":\"---\\nlabel: Select the most anomalous region\\n---\\nThe region(s) with the highest value of the score for which the result is significant for some significance level are identified as the (most) anomalous.\\n\",\"position\":{\"x\":736,\"y\":160}},\"type\":\"note\",\"width\":592,\"height\":272,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":736,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":816,\"y\":192}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726832534537\",\"data\":{\"name\":\"Note\",\"color\":\"#DCB0F2\",\"genAi\":false,\"label\":\"\",\"width\":464,\"height\":511.99600000000004,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Unnest result and join it with the input table\",\"position\":{\"x\":1312,\"y\":-16.004}},\"type\":\"note\",\"width\":528,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1312,\"y\":16},\"selected\":false,\"positionAbsolute\":{\"x\":1440,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726832534537-1726832563886\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":576,\"height\":511.99600000000004,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save the results to a table\",\"position\":{\"x\":1792,\"y\":-16.006}},\"type\":\"note\",\"width\":640,\"height\":624,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":1792,\"y\":16},\"selected\":false,\"positionAbsolute\":{\"x\":1984,\"y\":-128}},{\"id\":\"8ffdbe9d-bc24-47b1-9a75-a8d00ca2cc3a\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":399.99600000000004,\"height\":239.99699999999999,\"inputs\":[],\"markdown\":\"---\\nlabel: Chicago boundary enriched with expected crime rates\\n---\",\"position\":{\"x\":-416.002,\"y\":80}},\"type\":\"note\",\"width\":432,\"height\":240,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-416,\"y\":128},\"selected\":false,\"positionAbsolute\":{\"x\":-448,\"y\":80}},{\"id\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"data\":{\"name\":\"native.customsql\",\"label\":\"Custom SQL Select\",\"title\":\"SELECT TS W/ THE SAME TIMESTAMPS\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T1 AS(\\nSELECT *, COUNT(DISTINCT week) OVER(PARTITION BY h3) AS week_counts\\nFROM `$a`\\n),\\nT2 AS(\\nSELECT *, MAX(week_counts) OVER() AS week_counts_max\\nFROM T1\\n)\\nSELECT * EXCEPT(week_counts, week_counts_max)\\nFROM T2\\nWHERE week_counts = week_counts_max\"},{\"name\":\"optimizationcol\"}],\"version\":\"2.0.0\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":176,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":176,\"y\":320}},{\"id\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"data\":{\"name\":\"native.transpose\",\"label\":\"Transpose / Unpivot\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"keycols\",\"type\":\"Column\",\"title\":\"Key columns\",\"parent\":\"source\",\"mode\":\"multiple\",\"optional\":true,\"description\":\"Key columns\",\"value\":[\"h3\",\"week\"]},{\"name\":\"datacols\",\"type\":\"Column\",\"title\":\"Data columns\",\"parent\":\"source\",\"mode\":\"multiple\",\"description\":\"Data columns\",\"value\":[\"counts\",\"predicted_counts\"]},{\"name\":\"optimizationcol\",\"value\":\"h3\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1856,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":2064,\"y\":320}},{\"id\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"data\":{\"name\":\"native.h3boundary\",\"label\":\"H3 Boundary\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"h3col\",\"type\":\"Column\",\"title\":\"H3 column\",\"parent\":\"source\",\"placeholder\":\"h3\",\"dataType\":[\"string\"],\"description\":\"H3 column\",\"value\":\"h3\"},{\"name\":\"optimizationcol\",\"value\":\"h3_geo\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1984,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":2224,\"y\":320}},{\"id\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"data\":{\"name\":\"native.dropcolumn\",\"label\":\"Drop Columns\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Columns to drop\",\"parent\":\"source\",\"mode\":\"multiple\",\"noDefault\":true,\"description\":\"Columns to drop\",\"value\":[\"h3\"]},{\"name\":\"optimizationcol\",\"value\":\"h3_geo\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2112,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":2368,\"y\":320}},{\"id\":\"790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612\",\"data\":{\"name\":\"native.saveastable\",\"label\":\"Save as Table\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3_geo\"}],\"version\":\"1\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2240,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":2496,\"y\":320}},{\"id\":\"12542550-34a5-48b5-87dd-ee33f9802371\",\"data\":{\"name\":\"native.detectspacetimeanomalies\",\"type\":\"generic\",\"label\":\"Detect Space-time Anomalies\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"helper\":\"The source table must contain the index colum, the date column, a value column, the column representing the baseline value (called value_column_baseline) and optionally a the column representing the baseline variance (called value_column_baseline_sigma2)\",\"description\":\"Source table\"},{\"name\":\"indexcol\",\"type\":\"Column\",\"title\":\"Index column\",\"parent\":\"source\",\"allowedColumns\":[\"h3\",\"quadbin\"],\"helper\":\"The name of the column with the unique geographic identifier of the spatial index, either \\\"H3\\\" or \\\"QUADBIN\\\"\",\"dataType\":[\"string\",\"number\"],\"description\":\"Index column\",\"value\":\"h3\"},{\"name\":\"datecol\",\"type\":\"Column\",\"title\":\"Date column\",\"parent\":\"source\",\"excludedColumns\":[\"h3\",\"quadbin\"],\"helper\":\"The name of the column with the date identifier\",\"dataType\":[\"datetime\",\"timestamp\",\"date\"],\"description\":\"Date column\",\"value\":\"week\"},{\"name\":\"valuecol\",\"type\":\"Column\",\"title\":\"Value column\",\"parent\":\"source\",\"excludedColumns\":[\"h3\",\"quadbin\"],\"helper\":\"Select the column that should be used to detect the anomalies\",\"dataType\":[\"number\"],\"description\":\"Value column\",\"value\":\"counts\"},{\"name\":\"timefreq\",\"type\":\"Selection\",\"title\":\"Time Frequency\",\"helper\":\" The temporal frequency of the data\",\"options\":[\"SECOND\",\"MINUTE\",\"HOUR\",\"DAY\",\"WEEK\",\"MONTH\",\"QUARTER\",\"YEAR\"],\"description\":\"Time Frequency\",\"value\":\"WEEK\"},{\"name\":\"distmodel\",\"type\":\"Selection\",\"title\":\"Distributional Model\",\"helper\":\"The distributional model of the data\",\"options\":[\"POISSON\",\"GAUSSIAN\"],\"description\":\"Distributional Model\",\"value\":\"POISSON\"},{\"name\":\"estmethod\",\"type\":\"Selection\",\"title\":\"Estimation Method\",\"helper\":\"The estimation method used to detect the spacetime anomalies. In the population-based method we expect each observed value to be proportional to its baseline under the null hypothesis, while in the expectation-based method, we expect each observed value to be equal to its baseline under the null hypothesis\",\"options\":[\"EXPECTATION\",\"POPULATION\"],\"description\":\"Estimation Method\",\"value\":\"EXPECTATION\"},{\"name\":\"prospective\",\"type\":\"Boolean\",\"title\":\"Prospective analysis\",\"default\":true,\"helper\":\"Option to specify if the analysis is retrospective or prospective. In a prospective analysis, only temporal zones that end with the last timestamp are considered and the interest lies in detecting new emerging anomalies. In a retrospective analysis instead, the space-time anomalies can happen at any point in time over all the past data (a temporal zone can end at any timestamp)\",\"description\":\"Prospective analysis\",\"value\":true},{\"name\":\"highmeananomalies\",\"type\":\"Boolean\",\"title\":\"High-mean anomalies\",\"default\":true,\"helper\":\"Option to specify if the analysis is for detecting space-time zones higher or lower than the baseline.\",\"description\":\"High-mean anomalies\",\"value\":true},{\"name\":\"kringsize\",\"type\":\"Range\",\"title\":\"K-ring size\",\"default\":\"\",\"helper\":\"The minimum and maximum k-ring size\",\"optional\":true,\"allowExpressions\":false,\"advanced\":true,\"description\":\"K-ring size\",\"value\":\"[\\\"1\\\",\\\"2\\\"]\"},{\"name\":\"timebandwidth\",\"type\":\"Range\",\"title\":\"Temporal bandwidth\",\"default\":\"\",\"helper\":\"The minimum and maximum temporal window\",\"optional\":true,\"allowExpressions\":false,\"advanced\":true,\"description\":\"Temporal bandwidth\",\"value\":\"[\\\"4\\\",\\\"8\\\"]\"},{\"name\":\"permutations\",\"type\":\"Number\",\"title\":\"Number of permutations\",\"default\":99,\"helper\":\"The number of permutations used to derive the random replicas to test the anomaly statistical significance\",\"optional\":true,\"advanced\":true,\"description\":\"Number of permutations\",\"value\":99},{\"name\":\"maxresults\",\"type\":\"Number\",\"title\":\"Number of maximum results returned\",\"default\":10,\"helper\":\"The maximum number of space-time zones returned\",\"optional\":true,\"advanced\":true,\"description\":\"Number of maximum results returned\",\"value\":10}],\"version\":\"1\"},\"type\":\"generic\",\"zIndex\":2,\"position\":{\"x\":544,\"y\":320},\"selected\":false},{\"id\":\"7ae3eb68-c608-4f00-9c66-8c80190bb650\",\"data\":{\"name\":\"native.renamecolumn\",\"type\":\"generic\",\"label\":\"Rename Column\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column to rename\",\"parent\":\"source\",\"dataType\":[\"boolean\",\"geography\",\"number\",\"string\"],\"description\":\"Column to rename\",\"value\":\"predicted_counts\"},{\"name\":\"newname\",\"type\":\"String\",\"title\":\"New column name\",\"validation\":\"^[a-zA-Z_][a-zA-Z0-9_]*$\",\"allowExpressions\":false,\"description\":\"New column name\",\"value\":\"counts_baseline\"}],\"version\":\"1\"},\"type\":\"generic\",\"zIndex\":2,\"position\":{\"x\":368,\"y\":352},\"selected\":false},{\"id\":\"7f1f445d-5234-45a0-98b1-fd9486649a7d\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines\",\"name\":\"ReadTable\",\"size\":18744324,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_w_baselines\",\"nrows\":145348,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"counts_ratio\",\"type\":\"number\"},{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"principal_component_1\",\"type\":\"number\"},{\"name\":\"principal_component_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"number\"},{\"name\":\"seasonal_sin\",\"type\":\"number\"},{\"name\":\"seasonal_cos\",\"type\":\"number\"},{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"total_pop_sum\",\"type\":\"number\"},{\"name\":\"predicted_counts_ratio\",\"type\":\"number\"},{\"name\":\"predicted_counts\",\"type\":\"number\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1739891198708,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":true}]},\"originalSchema\":[{\"name\":\"counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"principal_component_1\",\"type\":\"FLOAT\"},{\"name\":\"principal_component_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_sin\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_cos\",\"type\":\"FLOAT\"},{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"total_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"predicted_counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"predicted_counts\",\"type\":\"INTEGER\"}]},\"type\":\"source\",\"zIndex\":2,\"position\":{\"x\":-320,\"y\":208},\"selected\":false}],\"edges\":[{\"id\":\"3f299660-b04a-4eab-bee5-2626e0f99a98result-a4710173-acfc-4655-bbc0-7ce88bf248d7source\",\"source\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"target\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7result-3b3ab9a5-6d09-4635-856d-cc5d47537c71source\",\"source\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"target\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-3b3ab9a5-6d09-4635-856d-cc5d47537c71match-3b7897da-c159-43f5-9fa2-b7eb54f20f18source\",\"source\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"target\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"selected\":false,\"sourceHandle\":\"match\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18result-3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091source\",\"source\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"target\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"reactflow__edge-3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091result-c664e78b-c9c1-4469-b5d8-a4d53671d17csourceb\",\"source\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"target\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\",\"animated\":false},{\"id\":\"reactflow__edge-c664e78b-c9c1-4469-b5d8-a4d53671d17cresult-fdfe0811-9133-49f8-ae04-502fbb715691source\",\"source\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"target\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"fdfe0811-9133-49f8-ae04-502fbb715691result-52a7c81a-bbc2-41f1-bdf1-a5c74ea1974bsource\",\"source\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"target\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974bresult-4d970df0-d124-430f-9c79-3016657341c6source\",\"source\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"target\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"4d970df0-d124-430f-9c79-3016657341c6result-790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612source\",\"source\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"target\":\"790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612\",\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"c3d9b752-8ecf-4dc3-84a7-5ad1b06c8a93\",\"source\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"target\":\"790c9db1-de41-4c50-a0f1-5f559087d964\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"f8d57606-285a-4578-abdd-6cc70443e56a\",\"type\":\"default\",\"source\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"target\":\"7ae3eb68-c608-4f00-9c66-8c80190bb650\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"7bb6b464-27fa-46fb-b0f5-6e99b9ad7faf\",\"type\":\"default\",\"source\":\"7ae3eb68-c608-4f00-9c66-8c80190bb650\",\"target\":\"12542550-34a5-48b5-87dd-ee33f9802371\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\",\"animated\":false},{\"id\":\"be6980b3-d79f-4ab8-9212-918d1ebacf05\",\"type\":\"default\",\"source\":\"12542550-34a5-48b5-87dd-ee33f9802371\",\"target\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"sourceHandle\":\"result\",\"targetHandle\":\"table\",\"animated\":false},{\"id\":\"a68166e5-e1b3-40dc-86a7-371df7cfbaef\",\"type\":\"default\",\"source\":\"7f1f445d-5234-45a0-98b1-fd9486649a7d\",\"target\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\",\"animated\":false},{\"id\":\"25d77caf-8157-4354-ae3d-f4edaa8cd9da\",\"type\":\"default\",\"source\":\"7f1f445d-5234-45a0-98b1-fd9486649a7d\",\"target\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\",\"animated\":false}],\"variables\":null,\"procedure\":{},\"schedule\":{},\"viewport\":{\"x\":295.36252272674983,\"y\":131.7105062020387,\"zoom\":0.6335431245266633},\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\",\"useCache\":false}"}
  */
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_e3980b81cc381fc6_result`
  AS
    WITH T1 AS(
    SELECT *, COUNT(DISTINCT week) OVER(PARTITION BY h3) AS week_counts
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines`
    ),
    T2 AS(
    SELECT *, MAX(week_counts) OVER() AS week_counts_max
    FROM T1
    )
    SELECT * EXCEPT(week_counts, week_counts_max)
    FROM T2
    WHERE week_counts = week_counts_max;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_7ab7d86f27b4a5eb_result`
  AS
    SELECT * EXCEPT (predicted_counts),
      predicted_counts AS counts_baseline
    FROM `WORKFLOW_bd8ce2e8cefa706f_e3980b81cc381fc6_result`;
  END;
  BEGIN
    CALL `carto-un.carto`.DETECT_SPACETIME_ANOMALIES(
    'SELECT * EXCEPT (week), CAST(week AS DATETIME) AS week FROM `WORKFLOW_bd8ce2e8cefa706f_7ab7d86f27b4a5eb_result`',
    'h3',
    'week',
    'counts',
    'WEEK',
    'cartodb-on-gcp-datascience.workflows_temp.__temp_fe61c4f8_0686_4ae6_8f99_83187b1fb8e9',
    '''
    {
      "kring_size": [
        1,
        2
      ],
      "time_bw": [
        4,
        8
      ],
      "is_prospective": true,
      "distributional_model": "POISSON",
      "estimation_method": "EXPECTATION",
      "is_high_mean_anomalies": true,
      "permutations": 99,
      "max_results": 10
    }
    '''
    );
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_a36ab27ef760f2b1_result`
  AS
    SELECT * FROM `cartodb-on-gcp-datascience.workflows_temp.__temp_fe61c4f8_0686_4ae6_8f99_83187b1fb8e9`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_c45a19733412540a_result`
  AS
    SELECT
      *
    FROM
      `WORKFLOW_bd8ce2e8cefa706f_a36ab27ef760f2b1_result`
    ORDER BY
      score DESC ;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_34f88b24b99e938d_result`
  AS
    SELECT ROW_NUMBER() OVER () AS row_count, *
    FROM `WORKFLOW_bd8ce2e8cefa706f_c45a19733412540a_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_3dcba10008876412_match`
  AS
    SELECT *
    FROM `WORKFLOW_bd8ce2e8cefa706f_34f88b24b99e938d_result`
    WHERE
      row_count = 1;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_94ef32951cad65ee_result`
  AS
    SELECT * EXCEPT (locations)
    FROM `WORKFLOW_bd8ce2e8cefa706f_3dcba10008876412_match`, UNNEST (locations) locations_unnested;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_3e14bba443b2a3a4_result`
  AS
    SELECT * EXCEPT (times)
    FROM `WORKFLOW_bd8ce2e8cefa706f_94ef32951cad65ee_result`, UNNEST (times) times_unnested;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_2d3a47ac877d093c_result`
  AS
    SELECT a.h3, a.week, a.counts, a.predicted_counts
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines` a
    JOIN `WORKFLOW_bd8ce2e8cefa706f_3e14bba443b2a3a4_result` b
    ON a.h3 = b.locations_unnested AND a.week = b.times_unnested;
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`
  AS
    SELECT * FROM `WORKFLOW_bd8ce2e8cefa706f_2d3a47ac877d093c_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_1bd8cf54dba67f37_result`
  AS
    SELECT
      h3, week, key, value
    FROM `WORKFLOW_bd8ce2e8cefa706f_2d3a47ac877d093c_result`
      UNPIVOT (
        value FOR key IN (
          counts,predicted_counts
        )
      );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_2424a96f031f4d36_result`
  AS
    SELECT
      `carto-un.carto`.H3_BOUNDARY(
          h3
      ) h3_geo, *
    FROM `WORKFLOW_bd8ce2e8cefa706f_1bd8cf54dba67f37_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_bd8ce2e8cefa706f_9e2490a83ce50cce_result`
  AS
    SELECT * EXCEPT (h3)
    FROM `WORKFLOW_bd8ce2e8cefa706f_2424a96f031f4d36_result`;
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot`
  CLUSTER BY h3_geo
  AS
    SELECT * FROM `WORKFLOW_bd8ce2e8cefa706f_9e2490a83ce50cce_result`;
  END;
END;