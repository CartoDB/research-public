-- WARNING: This procedure requires the Analytics Toolbox and assumes it will be located
-- at the following path: CARTO.CARTO. If you want to deploy and
-- run it in a different location, you will need to update the code accordingly.
CREATE OR REPLACE PROCEDURE
  ARGYRIOS.WORKFLOWS_TEMP.wfproc_9dd82695fb6a5556(
  )
  RETURNS VARCHAR
  LANGUAGE SQL
  AS
  $$
  /*
   {"versionId":"6943c5dcf99502ea","paramsId":"97d170e1550eee4a","isImmutable":true,"diagramJson":"{\"tags\":[],\"edges\":[{\"id\":\"reactflow__edge-c6a2c3e4-dbf2-4f5e-b502-999da77d4095out-2b6011c1-7fcf-42eb-9cdb-7c812e76d00bsourcea\",\"source\":\"c6a2c3e4-dbf2-4f5e-b502-999da77d4095\",\"target\":\"2b6011c1-7fcf-42eb-9cdb-7c812e76d00b\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\"},{\"id\":\"1ab2f105-3380-47f7-9439-87d6e4106914result-58d7bd2f-7610-449f-99e7-efe9e09e20a2sourcea\",\"source\":\"1ab2f105-3380-47f7-9439-87d6e4106914\",\"target\":\"58d7bd2f-7610-449f-99e7-efe9e09e20a2\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-c6a2c3e4-dbf2-4f5e-b502-999da77d4095out-6520dc7e-8ac0-49ab-b6c8-139718e0a2b2sourcea\",\"source\":\"c6a2c3e4-dbf2-4f5e-b502-999da77d4095\",\"target\":\"6520dc7e-8ac0-49ab-b6c8-139718e0a2b2\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-2b6011c1-7fcf-42eb-9cdb-7c812e76d00bresult-6520dc7e-8ac0-49ab-b6c8-139718e0a2b2sourceb\",\"source\":\"2b6011c1-7fcf-42eb-9cdb-7c812e76d00b\",\"target\":\"6520dc7e-8ac0-49ab-b6c8-139718e0a2b2\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\"},{\"id\":\"reactflow__edge-2b6011c1-7fcf-42eb-9cdb-7c812e76d00bresult-1ab2f105-3380-47f7-9439-87d6e4106914sourcea\",\"source\":\"2b6011c1-7fcf-42eb-9cdb-7c812e76d00b\",\"target\":\"1ab2f105-3380-47f7-9439-87d6e4106914\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-6520dc7e-8ac0-49ab-b6c8-139718e0a2b2result-1ab2f105-3380-47f7-9439-87d6e4106914sourceb\",\"source\":\"6520dc7e-8ac0-49ab-b6c8-139718e0a2b2\",\"target\":\"1ab2f105-3380-47f7-9439-87d6e4106914\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\"},{\"id\":\"reactflow__edge-35360267-06aa-4c68-8b36-994625216fd4result-d368b47e-f796-44ca-9f69-4f1611152f40source\",\"source\":\"35360267-06aa-4c68-8b36-994625216fd4\",\"target\":\"d368b47e-f796-44ca-9f69-4f1611152f40\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-58d7bd2f-7610-449f-99e7-efe9e09e20a2result-35360267-06aa-4c68-8b36-994625216fd4sourcea\",\"source\":\"58d7bd2f-7610-449f-99e7-efe9e09e20a2\",\"target\":\"35360267-06aa-4c68-8b36-994625216fd4\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"d368b47e-f796-44ca-9f69-4f1611152f40result-1076ce96-2f5d-4e3f-9538-4f128c865a98source\",\"source\":\"d368b47e-f796-44ca-9f69-4f1611152f40\",\"target\":\"1076ce96-2f5d-4e3f-9538-4f128c865a98\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-58d7bd2f-7610-449f-99e7-efe9e09e20a2result-105f123d-40ae-4392-a3fb-052d61cf64b0source\",\"source\":\"58d7bd2f-7610-449f-99e7-efe9e09e20a2\",\"target\":\"105f123d-40ae-4392-a3fb-052d61cf64b0\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"}],\"nodes\":[{\"id\":\"d368b47e-f796-44ca-9f69-4f1611152f40\",\"data\":{\"name\":\"native.getisordspacetime\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"indexcol\",\"type\":\"Column\",\"title\":\"Index column\",\"parent\":\"source\",\"dataType\":[\"string\",\"number\"],\"description\":\"Index column\",\"value\":\"H3\",\"options\":[\"H3\",\"DURATION\"]},{\"name\":\"datecol\",\"type\":\"Column\",\"title\":\"Date column\",\"parent\":\"source\",\"dataType\":[\"datetime\",\"timestamp\",\"date\"],\"description\":\"Date column\",\"value\":\"HOUR_DATE\",\"options\":[\"HOUR_DATE\"]},{\"name\":\"valuecol\",\"type\":\"Column\",\"title\":\"Value column\",\"parent\":\"source\",\"dataType\":[\"number\"],\"description\":\"Value column\",\"value\":\"DURATION\",\"options\":[\"DURATION\"]},{\"name\":\"kernel\",\"type\":\"Selection\",\"title\":\"Kernel function for spatial weights\",\"options\":[\"uniform\",\"triangular\",\"quadratic\",\"quartic\",\"gaussian\"],\"description\":\"Kernel function for spatial weights\",\"value\":\"gaussian\"},{\"name\":\"kerneltime\",\"type\":\"Selection\",\"title\":\"Kernel function for temporal weights\",\"options\":[\"uniform\",\"triangular\",\"quadratic\",\"quartic\",\"gaussian\"],\"description\":\"Kernel function for temporal weights\",\"value\":\"gaussian\"},{\"name\":\"size\",\"type\":\"Number\",\"title\":\"Size\",\"default\":3,\"min\":1,\"max\":10,\"description\":\"Size\",\"value\":\"3\"},{\"name\":\"bandwidth\",\"type\":\"Number\",\"title\":\"Temporal bandwidth\",\"default\":3,\"min\":1,\"max\":10,\"description\":\"Temporal bandwidth\",\"value\":\"1\"},{\"name\":\"timeinterval\",\"type\":\"Selection\",\"title\":\"Time interval\",\"options\":[\"year\",\"quarter\",\"month\",\"week\",\"day\",\"hour\",\"minute\",\"second\"],\"description\":\"Time interval\",\"value\":\"hour\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"H3\",\"GI\",\"P_VALUE\"]}],\"version\":\"1\",\"label\":\"Getis Ord Spacetime\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1344,\"y\":176},\"selected\":false,\"positionAbsolute\":{\"x\":1344,\"y\":176}},{\"id\":\"2b6011c1-7fcf-42eb-9cdb-7c812e76d00b\",\"data\":{\"name\":\"native.customsql\",\"title\":\"OutlierCleaner\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T AS (SELECT\\n  TRIP_ID,\\n  ARGYRIOS.AKYRGIAZOS_CARTO.OutlierCleaner(ARRAY_AGG(\\\"geometry\\\") WITHIN GROUP (ORDER BY \\\"datetime\\\"), \\n  ARRAY_AGG(\\\"datetime\\\") WITHIN GROUP (ORDER BY \\\"datetime\\\"), \\n  100) res\\nFROM\\n  $a\\ngroup by TRIP_ID)\\nSELECT TRIP_ID, GET(RR.value, 0)::TIMESTAMP t, GET(RR.value, 1)::STRING GEOM, GET(RR.value, 2)::FLOAT  speed\\nFROM T, LATERAL FLATTEN(input => res) RR\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":240,\"y\":144},\"selected\":false,\"positionAbsolute\":{\"x\":240,\"y\":144}},{\"id\":\"c6a2c3e4-dbf2-4f5e-b502-999da77d4095\",\"data\":{\"id\":\"ARGYRIOS.AKYRGIAZOS_CARTO.PORTO_TAXI_TRIPS\",\"name\":\"ReadTable\",\"size\":16935424,\"type\":\"table\",\"label\":\"PORTO_TAXI_TRIPS\",\"nrows\":1644742,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"ARGYRIOS.AKYRGIAZOS_CARTO.PORTO_TAXI_TRIPS\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"geo_len\",\"type\":\"number\"},{\"name\":\"geometry\",\"type\":\"string\"},{\"name\":\"TRIP_ID\",\"type\":\"number\"},{\"name\":\"TAXI_ID\",\"type\":\"number\"},{\"name\":\"MISSING_DATA\",\"type\":\"boolean\"},{\"name\":\"datetime\",\"type\":\"number\"}],\"enriched\":true,\"provider\":\"snowflake\",\"lastModified\":1712048583592,\"originalSchema\":[{\"name\":\"geo_len\",\"type\":\"NUMBER\"},{\"name\":\"geometry\",\"type\":\"TEXT\"},{\"name\":\"TRIP_ID\",\"type\":\"NUMBER\"},{\"name\":\"TAXI_ID\",\"type\":\"NUMBER\"},{\"name\":\"MISSING_DATA\",\"type\":\"BOOLEAN\"},{\"name\":\"datetime\",\"type\":\"NUMBER\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-208,\"y\":144},\"selected\":false,\"positionAbsolute\":{\"x\":-208,\"y\":144}},{\"id\":\"1ab2f105-3380-47f7-9439-87d6e4106914\",\"data\":{\"name\":\"native.customsql\",\"title\":\"SpaceClip\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T4 AS (SELECT\\n  H3,TRIP_ID,\\n  ARGYRIOS.AKYRGIAZOS_CARTO.trajectory_clip(ARRAY_AGG(GEOM) WITHIN GROUP (ORDER BY t), \\n  ARRAY_AGG(t) WITHIN GROUP (ORDER BY t), \\n  CARTO.CARTO.H3_BOUNDARY(H3)) res\\nFROM\\n  $a\\n  JOIN $b USING(TRIP_ID)\\ngroup by H3, TRIP_ID)\\nSELECT H3, TRIP_ID, GET(RR.value, 0)::TIMESTAMP t, GET(RR.value, 1)::STRING geom, GET(RR.value, 2) traj_id\\n    FROM T4, LATERAL FLATTEN(input => res) RR\\n\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":544,\"y\":144},\"selected\":false,\"positionAbsolute\":{\"x\":544,\"y\":144}},{\"id\":\"58d7bd2f-7610-449f-99e7-efe9e09e20a2\",\"data\":{\"name\":\"native.customsql\",\"title\":\"TemporalSplitter\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T6 AS (SELECT H3, TRAJ_ID, TRIP_ID,\\n  ARGYRIOS.AKYRGIAZOS_CARTO.TemporalSplitter(ARRAY_AGG(geom) WITHIN GROUP (ORDER BY t), \\n  ARRAY_AGG(t) WITHIN GROUP (ORDER BY t), \\n  'hour') res\\n  FROM $a\\n  GROUP BY H3, TRAJ_ID, TRIP_ID)\\nSELECT H3, TRIP_ID, DATE_TRUNC('HOUR', GET(RR.value, 0)::TIMESTAMP) hour_date, GET(RR.value, 0)::TIMESTAMP t, to_geography(GET(RR.value, 1)::STRING) geom, GET(RR.value, 2) TRAJ_ID\\n    FROM T6, LATERAL FLATTEN(input => res) RR\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":848,\"y\":160},\"selected\":false,\"positionAbsolute\":{\"x\":848,\"y\":160}},{\"id\":\"6520dc7e-8ac0-49ab-b6c8-139718e0a2b2\",\"data\":{\"name\":\"native.customsql\",\"title\":\"Distinct H3 cells\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T3 AS (SELECT DISTINCT H3_POINT_TO_CELL(to_geography(\\\"geometry\\\"), 8) H3 FROM $a),\\nT3_1 AS (SELECT TRIP_ID, ST_COLLECT(to_geography(GEOM)) GEOM FROM $b group by TRIP_ID)\\nSELECT TRIP_ID, hh.value H3 FROM T3_1, \\nLATERAL FLATTEN(input=>H3_COVERAGE_STRINGS(try_to_geography(replace(ST_ASWKT(GEOM), 'MultiPoint', 'LineString')), 8)) hh\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":400,\"y\":432},\"selected\":false,\"positionAbsolute\":{\"x\":400,\"y\":432}},{\"id\":\"4dc776b0-3968-4ab7-a6cc-3fc7f9be30ce\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":319.99199999999996,\"height\":303.986,\"inputs\":[],\"markdown\":\"---\\nlabel: OutlierCleaner\\n---\\n## OutlierCleaner\\n**This part remove outliers from each trajectory assuming a max speed of 100 Km/h.**\",\"position\":{\"x\":111.992,\"y\":-32}},\"type\":\"note\",\"width\":352,\"height\":256,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":80,\"y\":-32},\"selected\":false,\"positionAbsolute\":{\"x\":80,\"y\":-32}},{\"id\":\"fe6f13ab-ab58-4c04-8a1e-7415e9870e86\",\"data\":{\"name\":\"Note\",\"color\":\"#F6CF71\",\"genAi\":false,\"label\":\"\",\"width\":335.99199999999996,\"height\":255.985,\"inputs\":[],\"markdown\":\"---\\nlabel: Trajectories to H3 cells\\n---\\n## Identify unique H3 cels that cover the Area of Interest\",\"position\":{\"x\":272,\"y\":272}},\"type\":\"note\",\"width\":336,\"height\":256,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":272,\"y\":272},\"selected\":false,\"positionAbsolute\":{\"x\":272,\"y\":272}},{\"id\":\"1f1d8ccf-786f-46c0-a47a-6730a7cdcc07\",\"data\":{\"name\":\"Note\",\"color\":\"#9EB9F3\",\"genAi\":false,\"label\":\"\",\"width\":320,\"height\":303.98699999999997,\"inputs\":[],\"markdown\":\"---\\nlabel: Trajectory space clip\\n---\\n## Trajectory space clip\\n**This component clips each trajectory to H3 cells** \",\"position\":{\"x\":400,\"y\":-32}},\"type\":\"note\",\"width\":192,\"height\":290,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":400,\"y\":-32},\"selected\":false,\"positionAbsolute\":{\"x\":400,\"y\":-32}},{\"id\":\"0b677fbd-0d90-4fad-b2e1-4c6e4f4a5631\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":304,\"height\":303.995,\"inputs\":[],\"markdown\":\"---\\nlabel: Temporal Splitter\\n---\\n## Temporal Splitter\\n**This component splits each h3/trajectory to hourly segments.**\",\"position\":{\"x\":720,\"y\":-32}},\"type\":\"note\",\"width\":208,\"height\":368,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":720,\"y\":-32},\"selected\":false,\"positionAbsolute\":{\"x\":720,\"y\":-32}},{\"id\":\"35360267-06aa-4c68-8b36-994625216fd4\",\"data\":{\"name\":\"native.customsql\",\"title\":\"Aggregate H3/hour\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T8 AS (SELECT H3, HOUR_DATE, TRAJ_ID, TIMESTAMPDIFF(SECOND, MIN(t), MAX(t)) DURATION\\n   FROM $a\\n   GROUP BY h3, hour_date, TRAJ_ID)\\n   SELECT H3::STRING H3, HOUR_DATE, SUM(duration) duration FROM T8 GROUP BY H3, hour_date\"},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1104,\"y\":176},\"selected\":false,\"positionAbsolute\":{\"x\":1104,\"y\":176}},{\"id\":\"5324f99b-51fa-4565-a9f3-5eba9daf2475\",\"data\":{\"name\":\"Note\",\"color\":\"#F6CF71\",\"genAi\":false,\"label\":\"\",\"width\":223.993,\"height\":303.993,\"inputs\":[],\"markdown\":\"---\\nlabel: Aggregate per H3/Hour\\n---\\n## Aggregate Data\\nThis component aggregates the data into H3 and hourly segments \",\"position\":{\"x\":1024,\"y\":-32}},\"type\":\"note\",\"width\":192,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1024,\"y\":-32},\"selected\":false,\"positionAbsolute\":{\"x\":1024,\"y\":-32}},{\"id\":\"1076ce96-2f5d-4e3f-9538-4f128c865a98\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_getisord\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"H3\",\"options\":[\"H3\",\"GI\",\"P_VALUE\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1536,\"y\":176},\"selected\":false,\"positionAbsolute\":{\"x\":1536,\"y\":176}},{\"id\":\"99fbed46-338a-4331-9443-ba8fb92b049e\",\"data\":{\"name\":\"Note\",\"color\":\"#F6CF71\",\"genAi\":false,\"label\":\"\",\"width\":688,\"height\":320,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Summary\\n**This workflow process the Porto Taxi trajectories:**\\n- **The First component removes gps based on speed, outlier cleaner.**\\n- **The Second component splits the trajectory using H3 polygons.**\\n- **The third component splits the trajectory at hourly intervals.**\\n- **The fourth component aggregates the sub-trajectory duration per H3/hour**\\n- **The last component performs Space Time Getis Ord on the H3/hourly data to identify the hotspots.**\\n\",\"position\":{\"x\":304,\"y\":-384}},\"type\":\"note\",\"width\":688,\"height\":320,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":304,\"y\":-384},\"selected\":false,\"positionAbsolute\":{\"x\":304,\"y\":-384}},{\"id\":\"7a6df774-a752-4ea9-960b-d91aa9f40b24\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":239.995,\"height\":303.994,\"inputs\":[],\"markdown\":\"---\\nlabel:SpaceTime Hotspots\\n---\\n## SpaceTime Hotspots\\nThis component performs space time hotspot analysis on the aggregated H3/hourly data\",\"position\":{\"x\":1248,\"y\":-32}},\"type\":\"note\",\"width\":212,\"height\":307,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1248,\"y\":-32},\"selected\":false,\"positionAbsolute\":{\"x\":1248,\"y\":-32}},{\"id\":\"105f123d-40ae-4392-a3fb-052d61cf64b0\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_temporalclip\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"sfsearchoptimizationcol\",\"type\":\"Column\",\"title\":\"Search optimization column\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Search optimization column\",\"value\":\"GEOM\",\"options\":[\"GEOM\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"boolean\",\"number\",\"string\"],\"providers\":[\"snowflake\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"H3\",\"TRIP_ID\",\"TRAJ_ID\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1072,\"y\":352},\"selected\":true,\"positionAbsolute\":{\"x\":1072,\"y\":352}}],\"title\":\"MovingPandas analysis in SF\",\"useCache\":true,\"viewport\":{\"x\":208.95824697149897,\"y\":255.15104349420972,\"zoom\":0.6150255338927136},\"description\":\"\",\"thumbnailUrl\":\"\",\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"snowflake\"}"}
  */
  DECLARE
    __outputtable STRING;
    __outputtablefqn STRING;
  BEGIN
    __outputtable := 'wfproc_9dd82695fb6a5556_out_' || SUBSTRING(MD5(''), 1, 16);
    __outputtablefqn := 'ARGYRIOS.WORKFLOWS_TEMP.wfproc_9dd82695fb6a5556_out_' || SUBSTRING(MD5(''), 1, 16);
    BEGIN
      CREATE OR REPLACE TEMPORARY TABLE ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_2AC86A6335280829_RESULT
      AS
       WITH T AS (SELECT
         TRIP_ID,
         ARGYRIOS.AKYRGIAZOS_CARTO.OutlierCleaner(ARRAY_AGG("geometry") WITHIN GROUP (ORDER BY "datetime"), 
         ARRAY_AGG("datetime") WITHIN GROUP (ORDER BY "datetime"), 
         100) res
       FROM
         ARGYRIOS.AKYRGIAZOS_CARTO.PORTO_TAXI_TRIPS
       group by TRIP_ID)
       SELECT TRIP_ID, GET(RR.value, 0)::TIMESTAMP t, GET(RR.value, 1)::STRING GEOM, GET(RR.value, 2)::FLOAT  speed
       FROM T, LATERAL FLATTEN(input => res) RR;
    END;
    BEGIN
      CREATE OR REPLACE TEMPORARY TABLE ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_E3B2ECF6D2235690_RESULT
      AS
       WITH T3 AS (SELECT DISTINCT H3_POINT_TO_CELL(to_geography("geometry"), 8) H3 FROM ARGYRIOS.AKYRGIAZOS_CARTO.PORTO_TAXI_TRIPS),
       T3_1 AS (SELECT TRIP_ID, ST_COLLECT(to_geography(GEOM)) GEOM FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_2AC86A6335280829_RESULT group by TRIP_ID)
       SELECT TRIP_ID, hh.value H3 FROM T3_1, 
       LATERAL FLATTEN(input=>H3_COVERAGE_STRINGS(try_to_geography(replace(ST_ASWKT(GEOM), 'MultiPoint', 'LineString')), 8)) hh;
    END;
    BEGIN
      CREATE OR REPLACE TEMPORARY TABLE ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_09BB0B7DC4F3E149_RESULT
      AS
       WITH T4 AS (SELECT
         H3,TRIP_ID,
         ARGYRIOS.AKYRGIAZOS_CARTO.trajectory_clip(ARRAY_AGG(GEOM) WITHIN GROUP (ORDER BY t), 
         ARRAY_AGG(t) WITHIN GROUP (ORDER BY t), 
         CARTO.CARTO.H3_BOUNDARY(H3)) res
       FROM
         ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_2AC86A6335280829_RESULT
         JOIN ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_E3B2ECF6D2235690_RESULT USING(TRIP_ID)
       group by H3, TRIP_ID)
       SELECT H3, TRIP_ID, GET(RR.value, 0)::TIMESTAMP t, GET(RR.value, 1)::STRING geom, GET(RR.value, 2) traj_id
           FROM T4, LATERAL FLATTEN(input => res) RR;
    END;
    BEGIN
      CREATE OR REPLACE TEMPORARY TABLE ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_276455DACF072BA1_RESULT
      AS
       WITH T6 AS (SELECT H3, TRAJ_ID, TRIP_ID,
         ARGYRIOS.AKYRGIAZOS_CARTO.TemporalSplitter(ARRAY_AGG(geom) WITHIN GROUP (ORDER BY t), 
         ARRAY_AGG(t) WITHIN GROUP (ORDER BY t), 
         'hour') res
         FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_09BB0B7DC4F3E149_RESULT
         GROUP BY H3, TRAJ_ID, TRIP_ID)
       SELECT H3, TRIP_ID, DATE_TRUNC('HOUR', GET(RR.value, 0)::TIMESTAMP) hour_date, GET(RR.value, 0)::TIMESTAMP t, to_geography(GET(RR.value, 1)::STRING) geom, GET(RR.value, 2) TRAJ_ID
           FROM T6, LATERAL FLATTEN(input => res) RR;
    END;
    BEGIN
      DROP TABLE IF EXISTS ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_temporalclip;
      CREATE OR REPLACE TABLE ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_temporalclip
      AS
      SELECT * FROM (
        SELECT * FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_276455DACF072BA1_RESULT
      )
      ORDER BY ST_GEOHASH(GEOM);
      BEGIN
        ALTER TABLE ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_temporalclip
          ADD search optimization
          ON GEO(GEOM);
      EXCEPTION WHEN OTHER THEN
          NULL;
      END;
    END;
    BEGIN
      CREATE OR REPLACE TEMPORARY TABLE ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_BE5B019AC4DFF307_RESULT
      AS
       WITH T8 AS (SELECT H3, HOUR_DATE, TRAJ_ID, TIMESTAMPDIFF(SECOND, MIN(t), MAX(t)) DURATION
       FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_276455DACF072BA1_RESULT
       GROUP BY h3, hour_date, TRAJ_ID)
       SELECT H3::STRING H3, HOUR_DATE, SUM(duration) duration FROM T8 GROUP BY H3, hour_date;
    END;
    BEGIN
      DECLARE
        grid_type STRING;
        WRONG_GRID_TYPE_EXCEPTION EXCEPTION;
      BEGIN
        grid_type := (
          CALL CARTO.CARTO._CHECK_GRID_INDEX_COLUMN(
            'SELECT * FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_BE5B019AC4DFF307_RESULT',
            'H3'
          )
        );
        IF (grid_type != 'unsupported') THEN
            EXECUTE IMMEDIATE '
                CALL CARTO.CARTO.GETIS_ORD_SPACETIME_' || grid_type || '(
                    ''ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_BE5B019AC4DFF307_RESULT'',
                    ''ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_CD23077BC0B101CB_RESULT'',
                    ''H3'',
                    ''HOUR_DATE'',
                    ''DURATION'',
                    3,
                    ''HOUR'',
                    1,
                    ''gaussian'',
                    ''gaussian''
                );
            ';
        ELSE
          RAISE WRONG_GRID_TYPE_EXCEPTION;
        END IF;
      END;
    END;
    BEGIN
      DROP TABLE IF EXISTS ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_getisord;
      CREATE OR REPLACE TABLE ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_getisord
      AS
       SELECT * FROM ARGYRIOS.WORKFLOWS_TEMP.WORKFLOW_9DD82695FB6A5556_CD23077BC0B101CB_RESULT;ALTER TABLE ARGYRIOS.AKYRGIAZOS_CARTO.taxi_porto_st_getisord CLUSTER BY (H3);
    END;
    EXECUTE IMMEDIATE
      'CREATE OR REPLACE TRANSIENT TABLE ' || __outputtablefqn || '
      AS
       SELECT 1 as dummy'
    ;
  END;
  $$