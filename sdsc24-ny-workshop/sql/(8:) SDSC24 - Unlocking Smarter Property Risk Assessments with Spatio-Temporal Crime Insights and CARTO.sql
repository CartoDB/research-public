-- WARNING: This procedure requires the Analytics Toolbox and assumes it will be located
-- at the following path: carto-un.carto. If you want to deploy and
-- run it in a different location, you will need to update the code accordingly.
CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_f5c9e65e1af27e04`(
)
BEGIN
  /*
   {"versionId":"6c4adcfa15cf1b7e","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"tags\":[],\"edges\":[{\"id\":\"fd4d65d0-98cb-41eb-ba1c-797b3ec69305result-3f299660-b04a-4eab-bee5-2626e0f99a98table\",\"source\":\"fd4d65d0-98cb-41eb-ba1c-797b3ec69305\",\"target\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"table\"},{\"id\":\"3f299660-b04a-4eab-bee5-2626e0f99a98result-a4710173-acfc-4655-bbc0-7ce88bf248d7source\",\"source\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"target\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7result-3b3ab9a5-6d09-4635-856d-cc5d47537c71source\",\"source\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"target\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-3b3ab9a5-6d09-4635-856d-cc5d47537c71match-3b7897da-c159-43f5-9fa2-b7eb54f20f18source\",\"source\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"target\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"match\",\"targetHandle\":\"source\"},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18result-3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091source\",\"source\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"target\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-33b20050-ab54-4596-86d3-a0e055efd937out-c664e78b-c9c1-4469-b5d8-a4d53671d17csourcea\",\"source\":\"33b20050-ab54-4596-86d3-a0e055efd937\",\"target\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091result-c664e78b-c9c1-4469-b5d8-a4d53671d17csourceb\",\"source\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"target\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\"},{\"id\":\"reactflow__edge-c664e78b-c9c1-4469-b5d8-a4d53671d17cresult-790c9db1-de41-4c50-a0f1-5f559087d964source\",\"source\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"target\":\"790c9db1-de41-4c50-a0f1-5f559087d964\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-594ef61b-8c9b-4320-bc35-5571e8c6ee96result-fd4d65d0-98cb-41eb-ba1c-797b3ec69305sourcea\",\"source\":\"594ef61b-8c9b-4320-bc35-5571e8c6ee96\",\"target\":\"fd4d65d0-98cb-41eb-ba1c-797b3ec69305\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-33b20050-ab54-4596-86d3-a0e055efd937out-2125f1ce-4d62-4ae1-a144-f257391ea902sourcea\",\"source\":\"33b20050-ab54-4596-86d3-a0e055efd937\",\"target\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"animated\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-2125f1ce-4d62-4ae1-a144-f257391ea902result-594ef61b-8c9b-4320-bc35-5571e8c6ee96sourcea\",\"source\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"target\":\"594ef61b-8c9b-4320-bc35-5571e8c6ee96\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-c664e78b-c9c1-4469-b5d8-a4d53671d17cresult-fdfe0811-9133-49f8-ae04-502fbb715691source\",\"source\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"target\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"fdfe0811-9133-49f8-ae04-502fbb715691result-52a7c81a-bbc2-41f1-bdf1-a5c74ea1974bsource\",\"source\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"target\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974bresult-4d970df0-d124-430f-9c79-3016657341c6source\",\"source\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"target\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"4d970df0-d124-430f-9c79-3016657341c6result-790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612source\",\"source\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"target\":\"790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"}],\"nodes\":[{\"id\":\"33b20050-ab54-4596-86d3-a0e055efd937\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines\",\"name\":\"ReadTable\",\"size\":18775590,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_w_baselines\",\"nrows\":145590,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"counts_ratio\",\"type\":\"number\"},{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"principal_component_1\",\"type\":\"number\"},{\"name\":\"principal_component_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"number\"},{\"name\":\"seasonal_sin\",\"type\":\"number\"},{\"name\":\"seasonal_cos\",\"type\":\"number\"},{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"total_pop_sum\",\"type\":\"number\"},{\"name\":\"predicted_counts_ratio\",\"type\":\"number\"},{\"name\":\"predicted_counts\",\"type\":\"number\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1726578633105,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":true}]},\"originalSchema\":[{\"name\":\"counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"principal_component_1\",\"type\":\"FLOAT\"},{\"name\":\"principal_component_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_sin\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_cos\",\"type\":\"FLOAT\"},{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"total_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"predicted_counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"predicted_counts\",\"type\":\"FLOAT\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-336,\"y\":144},\"selected\":false,\"positionAbsolute\":{\"x\":-336,\"y\":144}},{\"id\":\"fd4d65d0-98cb-41eb-ba1c-797b3ec69305\",\"data\":{\"name\":\"native.customsql\",\"title\":\"CUSTOM SELECT\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT *\\nFROM `<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies`\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":624,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":624,\"y\":352}},{\"id\":\"3f299660-b04a-4eab-bee5-2626e0f99a98\",\"data\":{\"name\":\"native.orderby\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Table to order\",\"description\":\"Table to order\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column to order by\",\"dataType\":[\"number\",\"string\",\"date\",\"time\",\"datetime\",\"timestamp\"],\"parent\":\"table\",\"description\":\"Column to order by\",\"value\":\"score\",\"options\":[\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]},{\"name\":\"desc\",\"type\":\"Boolean\",\"title\":\"Use descending order\",\"default\":false,\"description\":\"Use descending order\",\"value\":true},{\"name\":\"columnb\",\"type\":\"Column\",\"title\":\"Optional secondary column to order by\",\"parent\":\"table\",\"dataType\":[\"number\",\"string\",\"date\",\"time\",\"datetime\",\"timestamp\"],\"default\":null,\"optional\":true,\"description\":\"Optional secondary column to order by\",\"options\":[\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]},{\"name\":\"descb\",\"type\":\"Boolean\",\"title\":\"Use descending order in secondary column\",\"default\":false,\"description\":\"Use descending order in secondary column\",\"value\":false}],\"version\":\"1.0.2\",\"label\":\"Order by\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":864,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":864,\"y\":352}},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18\",\"data\":{\"name\":\"native.unnest\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"col\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"description\":\"Column\",\"value\":\"locations\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"times\",\"locations_unnested\"]}],\"version\":\"1\",\"label\":\"Unnest\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1520,\"y\":224},\"selected\":false,\"positionAbsolute\":{\"x\":1520,\"y\":224}},{\"id\":\"a4710173-acfc-4655-bbc0-7ce88bf248d7\",\"data\":{\"name\":\"native.rownumber\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]}],\"version\":\"1\",\"label\":\"Row number\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1040,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":1040,\"y\":352}},{\"id\":\"3b3ab9a5-6d09-4635-856d-cc5d47537c71\",\"data\":{\"name\":\"native.wheresimplified\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"dataType\":[\"string\",\"number\",\"date\",\"datetime\",\"time\",\"timestamp\",\"boolean\"],\"description\":\"Column\",\"value\":\"row_count\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]},{\"name\":\"operator\",\"type\":\"Selection\",\"title\":\"Operator\",\"options\":[\"equal to\",\"not equal\",\"less than\",\"greater than\",\"equal or less than\",\"equal or greater than\"],\"description\":\"Operator\",\"value\":\"equal to\"},{\"name\":\"value\",\"type\":\"String\",\"title\":\"Value\",\"description\":\"Value\",\"value\":\"1\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"match\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations\",\"times\"]}],\"version\":\"1\",\"label\":\"Simple Filter\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1216,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":1216,\"y\":352}},{\"id\":\"3b7897da-c159-43f5-9fa2-b7eb54f20f18-1726658359091\",\"data\":{\"name\":\"native.unnest\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"col\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"description\":\"Column\",\"value\":\"times\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"times\",\"locations_unnested\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"row_count\",\"index_scan\",\"score\",\"relrisk\",\"pgumbel\",\"locations_unnested\",\"times_unnested\"]}],\"version\":\"1\",\"label\":\"Unnest\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1664,\"y\":224},\"selected\":false,\"positionAbsolute\":{\"x\":1664,\"y\":224}},{\"id\":\"c664e78b-c9c1-4469-b5d8-a4d53671d17c\",\"data\":{\"name\":\"native.customsql\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT a.h3, a.week, a.counts, a.predicted_counts\\nFROM `$a` a\\nJOIN `$b` b\\nON a.h3 = b.locations_unnested AND a.week = b.times_unnested\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1840,\"y\":160},\"selected\":false,\"positionAbsolute\":{\"x\":1840,\"y\":160}},{\"id\":\"790c9db1-de41-4c50-a0f1-5f559087d964\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3\",\"options\":[\"h3\",\"week\",\"counts\",\"predicted_counts\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":true,\"position\":{\"x\":2128,\"y\":160},\"selected\":false,\"positionAbsolute\":{\"x\":2128,\"y\":160}},{\"id\":\"594ef61b-8c9b-4320-bc35-5571e8c6ee96\",\"data\":{\"name\":\"native.call\",\"title\":\"DETECT_SPACETIME_ANOMALIES\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL CALL statement\",\"mode\":\"multiline\",\"placeholder\":\"CALL MY_PROCEDURE($a, 10, $output);\",\"allowExpressions\":false,\"description\":\"SQL CALL statement\",\"value\":\"DROP TABLE IF EXISTS `<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies`;\\n\\nCALL `carto-un.carto.DETECT_SPACETIME_ANOMALIES` (\\n'''\\nSELECT week, h3, counts, predicted_counts AS counts_baseline\\nFROM `$a`\\n''',\\n'h3',\\n'week',\\n'counts',\\n'WEEK',\\n'<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies',\\n'''\\n{\\n'kring_size':[1,2],\\n'time_bw':[4,12],\\n'is_prospective': true,   'distributional_model':'POISSON',\\n'permutations':99,  'estimation_method':'EXPECTATION'\\n}\\n'''\\n)\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Call Procedure\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":432,\"y\":336},\"selected\":false,\"positionAbsolute\":{\"x\":432,\"y\":336}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":495.997,\"height\":623.9960000000001,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":-196.844,\"y\":-128.004}},\"type\":\"note\",\"width\":496,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-496,\"y\":-128},\"selected\":false,\"positionAbsolute\":{\"x\":-496,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1408,\"height\":623.996,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Detect space-time anomalies\\n\\nTo detect anomalies that affect multiple time series simultaneously, we adopt a [multi-resolution approach]() in which we search over a large and overlapping set of space-time regions, each containing some subset of the data, and find the most significant clusters of anomalous data.\",\"position\":{\"x\":16,\"y\":-128}},\"type\":\"note\",\"width\":1408,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":16,\"y\":-128},\"selected\":false,\"positionAbsolute\":{\"x\":16,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726831966580\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":736,\"height\":271.99600000000004,\"inputs\":[],\"markdown\":\"---\\nlabel: Call procedure\\n---\\nWe compute a score function that compares the probability that a space-time region _S_ is anomalous compared to some baseline to the probability of no anomalous regions.\",\"position\":{\"x\":64,\"y\":192}},\"type\":\"note\",\"width\":736,\"height\":272,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":64,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":64,\"y\":192}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726831966580-1726832000306\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":592,\"height\":271.996,\"inputs\":[],\"markdown\":\"---\\nlabel: Select the most anomalous region\\n---\\nThe region(s) with the highest value of the score for which the result is significant for some significance level are identified as the (most) anomalous.\\n\",\"position\":{\"x\":816,\"y\":207.996}},\"type\":\"note\",\"width\":592,\"height\":272,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":816,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":816,\"y\":192}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726832534537\",\"data\":{\"name\":\"Note\",\"color\":\"#DCB0F2\",\"genAi\":false,\"label\":\"\",\"width\":528,\"height\":623.996,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Unnest result and join it with the input table\",\"position\":{\"x\":1440,\"y\":-128}},\"type\":\"note\",\"width\":528,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1440,\"y\":-128},\"selected\":false,\"positionAbsolute\":{\"x\":1440,\"y\":-128}},{\"id\":\"d438cda0-25b6-4c7a-96b9-8c1da80eca28-1726831929476-1726832534537-1726832563886\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":640,\"height\":623.9960000000001,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save the results to a table\",\"position\":{\"x\":2096,\"y\":-128.004}},\"type\":\"note\",\"width\":640,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1984,\"y\":-128},\"selected\":false,\"positionAbsolute\":{\"x\":1984,\"y\":-128}},{\"id\":\"8ffdbe9d-bc24-47b1-9a75-a8d00ca2cc3a\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":431.998,\"height\":239.99699999999999,\"inputs\":[],\"markdown\":\"---\\nlabel: Chicago boundary enriched with expected crime rates\\n---\",\"position\":{\"x\":-146.162,\"y\":96}},\"type\":\"note\",\"width\":432,\"height\":240,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-448,\"y\":80},\"selected\":false,\"positionAbsolute\":{\"x\":-448,\"y\":80}},{\"id\":\"2125f1ce-4d62-4ae1-a144-f257391ea902\",\"data\":{\"name\":\"native.customsql\",\"title\":\"SELECT TS W/ THE SAME TIMESTAMPS\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"WITH T1 AS(\\nSELECT *, COUNT(DISTINCT week) OVER(PARTITION BY h3) AS week_counts\\nFROM `$a`\\n),\\nT2 AS(\\nSELECT *, MAX(week_counts) OVER() AS week_counts_max\\nFROM T1\\n)\\nSELECT * EXCEPT(week_counts, week_counts_max)\\nFROM T2\\nWHERE week_counts = week_counts_max\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":176,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":176,\"y\":320}},{\"id\":\"fdfe0811-9133-49f8-ae04-502fbb715691\",\"data\":{\"name\":\"native.transpose\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"keycols\",\"type\":\"Column\",\"title\":\"Key columns\",\"parent\":\"source\",\"mode\":\"multiple\",\"optional\":true,\"description\":\"Key columns\",\"value\":[\"h3\",\"week\"],\"options\":[\"h3\",\"week\",\"counts\",\"predicted_counts\"]},{\"name\":\"datacols\",\"type\":\"Column\",\"title\":\"Data columns\",\"parent\":\"source\",\"mode\":\"multiple\",\"description\":\"Data columns\",\"value\":[\"counts\",\"predicted_counts\"],\"options\":[\"h3\",\"week\",\"counts\",\"predicted_counts\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3\",\"options\":[\"h3\",\"week\",\"key\",\"value\"]}],\"version\":\"1\",\"label\":\"Transpose / Unpivot\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2064,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2064,\"y\":320}},{\"id\":\"52a7c81a-bbc2-41f1-bdf1-a5c74ea1974b\",\"data\":{\"name\":\"native.h3boundary\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"h3col\",\"type\":\"Column\",\"title\":\"H3 column\",\"parent\":\"source\",\"placeholder\":\"h3\",\"dataType\":[\"string\"],\"description\":\"H3 column\",\"value\":\"h3\",\"options\":[\"h3\",\"key\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3_geo\",\"options\":[\"h3_geo\",\"h3\",\"week\",\"key\",\"value\"]}],\"version\":\"1\",\"label\":\"H3 Boundary\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2224,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2224,\"y\":320}},{\"id\":\"4d970df0-d124-430f-9c79-3016657341c6\",\"data\":{\"name\":\"native.dropcolumn\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Columns to drop\",\"parent\":\"source\",\"mode\":\"multiple\",\"noDefault\":true,\"description\":\"Columns to drop\",\"value\":[\"h3\"],\"options\":[\"h3_geo\",\"h3\",\"week\",\"key\",\"value\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3_geo\",\"options\":[\"h3_geo\",\"week\",\"key\",\"value\"]}],\"version\":\"1\",\"label\":\"Drop Columns\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2368,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2368,\"y\":320}},{\"id\":\"790c9db1-de41-4c50-a0f1-5f559087d964-1727270974612\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3_geo\",\"options\":[\"h3_geo\",\"week\",\"key\",\"value\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2496,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2496,\"y\":320}}],\"title\":\"(8/) SDSC24 - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"useCache\":false,\"viewport\":{\"x\":240.24131653587077,\"y\":66.69319461111303,\"zoom\":0.3560125488992688},\"description\":\"\",\"thumbnailUrl\":\"\",\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\"}"}
  */
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_e3980b81cc381fc6_result`
  AS
    WITH T1 AS(
    SELECT *, COUNT(DISTINCT week) OVER(PARTITION BY h3) AS week_counts
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines`
    ),
    T2 AS(
    SELECT *, MAX(week_counts) OVER() AS week_counts_max
    FROM T1
    )
    SELECT * EXCEPT(week_counts, week_counts_max)
    FROM T2
    WHERE week_counts = week_counts_max;
  END;
  BEGIN
  DROP TABLE IF EXISTS `<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies`;
  CALL `cartodb-on-gcp-datascience.giulia_carto.DETECT_SPACETIME_ANOMALIES` (
  '''
  SELECT week, h3, counts, predicted_counts AS counts_baseline
  FROM `WORKFLOW_f5c9e65e1af27e04_e3980b81cc381fc6_result`
  ''',
  'h3',
  'week',
  'counts',
  'WEEK',
  '<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies',
  '''
  {
  'kring_size':[1,2],
  'time_bw':[4,12],
  'is_prospective': true,   'distributional_model':'POISSON',
  'permutations':99,  'estimation_method':'EXPECTATION'
  }
  '''
  );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_8f547e127bf3c1bf_result`
  AS
    SELECT *
    FROM `<my-project>.<my-dataset>.CHI_boundary_enriched_st_anomalies`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_b429717d5e0877ea_result`
  AS
    SELECT
      *
    FROM
      `WORKFLOW_f5c9e65e1af27e04_8f547e127bf3c1bf_result`
    ORDER BY
      score DESC ;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_333829cdb569d8ef_result`
  AS
    SELECT ROW_NUMBER() OVER () AS row_count, *
    FROM `WORKFLOW_f5c9e65e1af27e04_b429717d5e0877ea_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_06ff495501c51edf_match`
  AS
    SELECT *
    FROM `WORKFLOW_f5c9e65e1af27e04_333829cdb569d8ef_result`
    WHERE
      row_count = 1;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_8053035421790da1_result`
  AS
    SELECT * EXCEPT (locations)
    FROM `WORKFLOW_f5c9e65e1af27e04_06ff495501c51edf_match`, UNNEST (locations) locations_unnested;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_26c7f7bf538193fb_result`
  AS
    SELECT * EXCEPT (times)
    FROM `WORKFLOW_f5c9e65e1af27e04_8053035421790da1_result`, UNNEST (times) times_unnested;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_b3e1602d3ea4e4dd_result`
  AS
    SELECT a.h3, a.week, a.counts, a.predicted_counts
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines` a
    JOIN `WORKFLOW_f5c9e65e1af27e04_26c7f7bf538193fb_result` b
    ON a.h3 = b.locations_unnested AND a.week = b.times_unnested;
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`
  CLUSTER BY h3
  AS
    SELECT * FROM `WORKFLOW_f5c9e65e1af27e04_b3e1602d3ea4e4dd_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_c7ffe9063d768192_result`
  CLUSTER BY h3
  AS
    SELECT
      h3, week, key, value
    FROM `WORKFLOW_f5c9e65e1af27e04_b3e1602d3ea4e4dd_result`
      UNPIVOT (
        value FOR key IN (
          counts,predicted_counts
        )
      );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_cad8c0565a042e69_result`
  CLUSTER BY h3_geo
  AS
    SELECT
      `carto-un.carto`.H3_BOUNDARY(
          h3
      ) h3_geo, *
    FROM `WORKFLOW_f5c9e65e1af27e04_c7ffe9063d768192_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_f5c9e65e1af27e04_45b8647a491bf5d5_result`
  CLUSTER BY h3_geo
  AS
    SELECT * EXCEPT (h3)
    FROM `WORKFLOW_f5c9e65e1af27e04_cad8c0565a042e69_result`;
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_pivot`
  CLUSTER BY h3_geo
  AS
    SELECT * FROM `WORKFLOW_f5c9e65e1af27e04_45b8647a491bf5d5_result`;
  END;
END;
