CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_62d8b5586bc34a3c`(
)
BEGIN
  /*
   {"versionId":"31ba4ee1a5990e73","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"tags\":[],\"edges\":[{\"id\":\"63d48e1d-bb27-4e67-a211-508995d77601result-90cefe53-db69-456b-9c73-432e7ef7fb0fsourcea\",\"source\":\"63d48e1d-bb27-4e67-a211-508995d77601\",\"target\":\"90cefe53-db69-456b-9c73-432e7ef7fb0f\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-63d48e1d-bb27-4e67-a211-508995d77601result-ee3041d5-29f6-4519-959b-08edaaccc749sourceb\",\"source\":\"63d48e1d-bb27-4e67-a211-508995d77601\",\"target\":\"ee3041d5-29f6-4519-959b-08edaaccc749\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\"},{\"id\":\"reactflow__edge-90cefe53-db69-456b-9c73-432e7ef7fb0fresult-ee3041d5-29f6-4519-959b-08edaaccc749sourcea\",\"source\":\"90cefe53-db69-456b-9c73-432e7ef7fb0f\",\"target\":\"ee3041d5-29f6-4519-959b-08edaaccc749\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"ee3041d5-29f6-4519-959b-08edaaccc749result-8b139b9a-c4de-466e-99c1-2a4888358bcetable\",\"source\":\"ee3041d5-29f6-4519-959b-08edaaccc749\",\"target\":\"8b139b9a-c4de-466e-99c1-2a4888358bce\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"table\"},{\"id\":\"reactflow__edge-8b139b9a-c4de-466e-99c1-2a4888358bceresult-a6239dad-2039-4079-81f1-0ebc6a96248dsource\",\"source\":\"8b139b9a-c4de-466e-99c1-2a4888358bce\",\"target\":\"a6239dad-2039-4079-81f1-0ebc6a96248d\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-c202729c-19e5-4329-97ab-b1b4a602bf14out-63d48e1d-bb27-4e67-a211-508995d77601table\",\"source\":\"c202729c-19e5-4329-97ab-b1b4a602bf14\",\"target\":\"63d48e1d-bb27-4e67-a211-508995d77601\",\"animated\":false,\"selected\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"table\"}],\"nodes\":[{\"id\":\"f205bded-2345-4729-902e-bf330725e481\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":511.993,\"height\":623.9970000000001,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":1545,\"y\":-64}},\"type\":\"note\",\"width\":512,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1552,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":1552,\"y\":-64}},{\"id\":\"90cefe53-db69-456b-9c73-432e7ef7fb0f\",\"data\":{\"name\":\"native.call\",\"title\":\"IMPORT MODEL\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL CALL statement\",\"mode\":\"multiline\",\"placeholder\":\"CALL MY_PROCEDURE($a, 10, $output);\",\"allowExpressions\":false,\"description\":\"SQL CALL statement\",\"value\":\"CREATE OR REPLACE MODEL `cartobq.sdsc24_ny_workshops.CHI_boundary_SKLEARN_ONNX_model_opset8`\\nOPTIONS (MODEL_TYPE='ONNX',  MODEL_PATH='gs://sdsc_workshops/sdsc24_10/arima_plus_model_opset8_onehot.onnx');\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Call Procedure\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2432,\"y\":208},\"selected\":true,\"positionAbsolute\":{\"x\":2432,\"y\":208}},{\"id\":\"63d48e1d-bb27-4e67-a211-508995d77601\",\"data\":{\"name\":\"native.select\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"select\",\"type\":\"StringSql\",\"title\":\"SELECT statement\",\"placeholder\":\"E.g.: *, distance_in_km * 1000 AS distance_in_meters\",\"allowExpressions\":false,\"description\":\"SELECT statement\",\"value\":\"counts_ratio,\\nh3,\\nprincipal_component_1,\\nprincipal_component_2,\\ncounts_ratio_kring2,\\ncounts_ratio_lag_1,\\ncounts_ratio_lag_2,\\ncounts_ratio_lag_3,\\nseasonal_sin,\\nseasonal_cos,\\nweek,\\ncounts,\\ntotal_pop_sum\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1\",\"label\":\"Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2176,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":2176,\"y\":192}},{\"id\":\"ee3041d5-29f6-4519-959b-08edaaccc749\",\"data\":{\"name\":\"native.customsql\",\"title\":\"PREDICT\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT *\\nFROM ML.PREDICT(\\nMODEL `cartobq.sdsc24_ny_workshops.CHI_boundary_arima_plus_xreg_model`, \\n(SELECT * FROM `$b`)\\n)\\n\\nORDER BY h3, week\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2640,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2640,\"y\":320}},{\"id\":\"a6239dad-2039-4079-81f1-0ebc6a96248d\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3\",\"options\":[\"counts_ratio\",\"h3\",\"principal_component_1\",\"principal_component_2\",\"counts_ratio_kring2\",\"counts_ratio_lag_1\",\"counts_ratio_lag_2\",\"counts_ratio_lag_3\",\"seasonal_sin\",\"seasonal_cos\",\"week\",\"counts\",\"total_pop_sum\",\"predicted_counts_ratio\",\"predicted_counts\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":3136,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":3136,\"y\":320}},{\"id\":\"8b139b9a-c4de-466e-99c1-2a4888358bce\",\"data\":{\"name\":\"native.select\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"select\",\"type\":\"StringSql\",\"title\":\"SELECT statement\",\"placeholder\":\"E.g.: *, distance_in_km * 1000 AS distance_in_meters\",\"allowExpressions\":false,\"description\":\"SELECT statement\",\"value\":\"* EXCEPT(predicted_counts_ratio), CASE WHEN predicted_counts_ratio < 0 THEN 0 ELSE predicted_counts_ratio END AS predicted_counts_ratio,\\nCASE WHEN predicted_counts_ratio < 0 THEN 0 ELSE CAST(predicted_counts_ratio / 1000 * total_pop_sum AS INT) END AS predicted_counts\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1\",\"label\":\"Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2800,\"y\":320},\"selected\":false,\"positionAbsolute\":{\"x\":2800,\"y\":320}},{\"id\":\"a7c19694-9a93-4059-a569-3253bff0f2f5-1726578426527\",\"data\":{\"name\":\"Note\",\"color\":\"#DCB0F2\",\"genAi\":false,\"label\":\"\",\"width\":927.9929999999999,\"height\":623.997,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Estimate the expected value of the series conditional on the selected covariates\\n\\nTo estimate the expected crime rate per 1,000 people, we can import a pre-trained model [from GCS using scikit-learn](https://cloud.google.com/bigquery/docs/reference/standard-sql/bigqueryml-syntax-create-onnx). This approach is useful when training and prediction are handled in separate processes (e.g., a data scientist trains the model, while an analyst performs the forecasting) or for specific use cases such as online predictions or predictions based on different data sets.\",\"position\":{\"x\":2080,\"y\":-64}},\"type\":\"note\",\"width\":928,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":2080,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":2080,\"y\":-64}},{\"id\":\"a7c19694-9a93-4059-a569-3253bff0f2f5-1726578426527-1726578437332\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":527.9989999999999,\"height\":623.995,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save results to a table\",\"position\":{\"x\":3024,\"y\":-64}},\"type\":\"note\",\"width\":528,\"height\":624,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":3024,\"y\":-64},\"selected\":false,\"positionAbsolute\":{\"x\":3024,\"y\":-64}},{\"id\":\"c202729c-19e5-4329-97ab-b1b4a602bf14\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags\",\"name\":\"ReadTable\",\"size\":32946775,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_w_lags\",\"nrows\":142025,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"year\",\"type\":\"number\"},{\"name\":\"month\",\"type\":\"number\"},{\"name\":\"total_pop_sum\",\"type\":\"number\"},{\"name\":\"median_age_avg\",\"type\":\"number\"},{\"name\":\"median_rent_avg\",\"type\":\"number\"},{\"name\":\"black_pop_sum\",\"type\":\"number\"},{\"name\":\"hispanic_pop_sum\",\"type\":\"number\"},{\"name\":\"owner_occupied_housing_units_median_value_sum\",\"type\":\"number\"},{\"name\":\"vacant_housing_units_sum\",\"type\":\"number\"},{\"name\":\"housing_units_sum\",\"type\":\"number\"},{\"name\":\"families_with_young_children_sum\",\"type\":\"number\"},{\"name\":\"urbanity_any\",\"type\":\"string\"},{\"name\":\"urbanity_any_ordinal\",\"type\":\"number\"},{\"name\":\"principal_component_1\",\"type\":\"number\"},{\"name\":\"principal_component_2\",\"type\":\"number\"},{\"name\":\"counts_ratio\",\"type\":\"number\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"number\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"number\"},{\"name\":\"seasonal_sin\",\"type\":\"number\"},{\"name\":\"seasonal_cos\",\"type\":\"number\"},{\"name\":\"week_joined\",\"type\":\"timestamp\"},{\"name\":\"region_joined\",\"type\":\"string\"},{\"name\":\"holiday_name\",\"type\":\"string\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1726753009838,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":true}]},\"originalSchema\":[{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"year\",\"type\":\"INTEGER\"},{\"name\":\"month\",\"type\":\"INTEGER\"},{\"name\":\"total_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"median_age_avg\",\"type\":\"FLOAT\"},{\"name\":\"median_rent_avg\",\"type\":\"FLOAT\"},{\"name\":\"black_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"hispanic_pop_sum\",\"type\":\"FLOAT\"},{\"name\":\"owner_occupied_housing_units_median_value_sum\",\"type\":\"FLOAT\"},{\"name\":\"vacant_housing_units_sum\",\"type\":\"FLOAT\"},{\"name\":\"housing_units_sum\",\"type\":\"FLOAT\"},{\"name\":\"families_with_young_children_sum\",\"type\":\"FLOAT\"},{\"name\":\"urbanity_any\",\"type\":\"STRING\"},{\"name\":\"urbanity_any_ordinal\",\"type\":\"INTEGER\"},{\"name\":\"principal_component_1\",\"type\":\"FLOAT\"},{\"name\":\"principal_component_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_kring2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_1\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_2\",\"type\":\"FLOAT\"},{\"name\":\"counts_ratio_lag_3\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_sin\",\"type\":\"FLOAT\"},{\"name\":\"seasonal_cos\",\"type\":\"FLOAT\"},{\"name\":\"week_joined\",\"type\":\"DATE\"},{\"name\":\"region_joined\",\"type\":\"STRING\"},{\"name\":\"holiday_name\",\"type\":\"STRING\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1696,\"y\":192},\"selected\":false,\"positionAbsolute\":{\"x\":1696,\"y\":192}},{\"id\":\"c7b53475-4e29-4923-a75c-f8ef8fda3890\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":479.99299999999994,\"height\":223.998,\"inputs\":[],\"markdown\":\"---\\nlabel: Chicago boundary enriched and pre-processed (FAMD) data:\\n---\\n\",\"position\":{\"x\":1568,\"y\":128}},\"type\":\"note\",\"width\":480,\"height\":224,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1568,\"y\":128},\"selected\":false,\"positionAbsolute\":{\"x\":1568,\"y\":128}}],\"title\":\"(7/) SDSC24 - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"useCache\":false,\"viewport\":{\"x\":-1004.7656802348486,\"y\":83.44828207570242,\"zoom\":0.658839975867073},\"description\":\"\",\"thumbnailUrl\":\"\",\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\"}"}
  */
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_62d8b5586bc34a3c_d579f92b5a05a4a5_result`
  AS
    SELECT counts_ratio,
    h3,
    principal_component_1,
    principal_component_2,
    counts_ratio_kring2,
    counts_ratio_lag_1,
    counts_ratio_lag_2,
    counts_ratio_lag_3,
    seasonal_sin,
    seasonal_cos,
    week,
    counts,
    total_pop_sum
                FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_lags`;
  END;
  BEGIN
  CREATE OR REPLACE MODEL `cartobq.sdsc24_ny_workshops.CHI_boundary_SKLEARN_ONNX_model_opset8`
  OPTIONS (MODEL_TYPE='ONNX',  MODEL_PATH='gs://sdsc_workshops/sdsc24_10/arima_plus_model_opset8_onehot.onnx');
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_62d8b5586bc34a3c_5672e96f9820ca4e_result`
  AS
    SELECT *
    FROM ML.PREDICT(
    MODEL `cartobq.sdsc24_ny_workshops.CHI_boundary_arima_plus_xreg_model`, 
    (SELECT * FROM `WORKFLOW_62d8b5586bc34a3c_d579f92b5a05a4a5_result`)
    )
    ORDER BY h3, week;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_62d8b5586bc34a3c_063eb01b269f305b_result`
  AS
    SELECT * EXCEPT(predicted_counts_ratio), CASE WHEN predicted_counts_ratio < 0 THEN 0 ELSE predicted_counts_ratio END AS predicted_counts_ratio,
    CASE WHEN predicted_counts_ratio < 0 THEN 0 ELSE CAST(predicted_counts_ratio / 1000 * total_pop_sum AS INT) END AS predicted_counts
                FROM `WORKFLOW_62d8b5586bc34a3c_5672e96f9820ca4e_result`;
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_w_baselines`
  CLUSTER BY h3
  AS
    SELECT * FROM `WORKFLOW_62d8b5586bc34a3c_063eb01b269f305b_result`;
  END;
END;