-- WARNING: This procedure requires the Analytics Toolbox and assumes it will be located
-- at the following path: carto-un.carto. If you want to deploy and
-- run it in a different location, you will need to update the code accordingly.
CREATE OR REPLACE PROCEDURE
  `cartodb-on-gcp-datascience.workflows_temp.wfproc_9399426d2a33e433`(
)
BEGIN
  /*
   {"versionId":"d28fe19c4de2cbcb","paramsId":"97d170e1550eee4a","isImmutable":false,"diagramJson":"{\"tags\":[],\"edges\":[{\"id\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18result-335e6ad2-6862-485e-9c3f-4acf8b3bed19main\",\"source\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"target\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"main\"},{\"id\":\"reactflow__edge-fe63978b-c663-4be1-bcee-94fa88942b11out-335e6ad2-6862-485e-9c3f-4acf8b3bed19secondary\",\"source\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"target\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"animated\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"secondary\"},{\"id\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7result-79561f1c-5e64-4c1c-82f7-fa75ac682176source\",\"source\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"target\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-79561f1c-5e64-4c1c-82f7-fa75ac682176match-14197a14-59bf-4e50-a0c2-19503ca4bb18source\",\"source\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"target\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"animated\":false,\"sourceHandle\":\"match\",\"targetHandle\":\"source\"},{\"id\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5result-1e310368-3313-4d5a-a086-de1417a1077fsource\",\"source\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"target\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-1e310368-3313-4d5a-a086-de1417a1077fmatch-0e6789ec-651b-4567-8d5b-d5c6c143e8d7table\",\"source\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"target\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"animated\":false,\"sourceHandle\":\"match\",\"targetHandle\":\"table\"},{\"id\":\"reactflow__edge-335e6ad2-6862-485e-9c3f-4acf8b3bed19result-61b36200-c5bb-40a6-8009-f34cd7a7c0b1maintable\",\"source\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"target\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"maintable\"},{\"id\":\"reactflow__edge-fe63978b-c663-4be1-bcee-94fa88942b11out-61b36200-c5bb-40a6-8009-f34cd7a7c0b1secondarytable\",\"source\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"target\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"animated\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"secondarytable\"},{\"id\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1result-95bdb371-bbb7-4021-8c87-9564c7140da8source\",\"source\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"target\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"95bdb371-bbb7-4021-8c87-9564c7140da8result-18276d66-d586-4b76-ac47-e602b3885d3bsource\",\"source\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"target\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"animated\":false,\"selected\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-18276d66-d586-4b76-ac47-e602b3885d3bresult-fcad1fdd-af00-46ae-8ab8-dcd023780dffsourcea\",\"source\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"target\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourcea\"},{\"id\":\"reactflow__edge-d652ae36-0ea9-46ee-815c-d726884542d0out-5061c491-312a-4100-a2ac-c8d65bab634esource\",\"source\":\"d652ae36-0ea9-46ee-815c-d726884542d0\",\"target\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"animated\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-456bd2d5-3457-4ecc-9093-6bded8c4cf04out-7746af6f-3ea9-4e43-93b5-9e99afdae2a5source\",\"source\":\"456bd2d5-3457-4ecc-9093-6bded8c4cf04\",\"target\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"animated\":false,\"sourceHandle\":\"out\",\"targetHandle\":\"source\"},{\"id\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dffresult-a6bd614b-be85-4c52-b230-9199ad01fceesource\",\"source\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"target\":\"a6bd614b-be85-4c52-b230-9199ad01fcee\",\"animated\":false,\"className\":\"\",\"sourceHandle\":\"result\",\"targetHandle\":\"source\"},{\"id\":\"reactflow__edge-5061c491-312a-4100-a2ac-c8d65bab634eresult-fcad1fdd-af00-46ae-8ab8-dcd023780dffsourceb\",\"source\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"target\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"animated\":false,\"sourceHandle\":\"result\",\"targetHandle\":\"sourceb\"}],\"nodes\":[{\"id\":\"456bd2d5-3457-4ecc-9093-6bded8c4cf04\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings\",\"name\":\"ReadTable\",\"size\":14295251,\"type\":\"table\",\"label\":\"CHI_boundary_311_vacant_buildings\",\"nrows\":65119,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"SERVICE REQUEST TYPE\",\"type\":\"string\"},{\"name\":\"SERVICE REQUEST NUMBER\",\"type\":\"string\"},{\"name\":\"DATE SERVICE REQUEST WAS RECEIVED\",\"type\":\"string\"},{\"name\":\"LOCATION OF BUILDING ON THE LOT - IF GARAGE CHANGE TYPE CODE TO BGD-\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING DANGEROUS OR HAZARDOUS\",\"type\":\"number\"},{\"name\":\"IS BUILDING OPEN OR BOARDED\",\"type\":\"string\"},{\"name\":\"IF THE BUILDING IS OPEN WHERE IS THE ENTRY POINT\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING CURRENTLY VACANT OR OCCUPIED\",\"type\":\"string\"},{\"name\":\"IS THE BUILDING VACANT DUE TO FIRE\",\"type\":\"number\"},{\"name\":\"ANY PEOPLE USING PROPERTY - HOMELESS CHILDEN GANGS-\",\"type\":\"number\"},{\"name\":\"ADDRESS STREET NUMBER\",\"type\":\"number\"},{\"name\":\"ADDRESS STREET DIRECTION\",\"type\":\"string\"},{\"name\":\"ADDRESS STREET NAME\",\"type\":\"string\"},{\"name\":\"ADDRESS STREET SUFFIX\",\"type\":\"string\"},{\"name\":\"ZIP CODE\",\"type\":\"number\"},{\"name\":\"X COORDINATE\",\"type\":\"number\"},{\"name\":\"Y COORDINATE\",\"type\":\"number\"},{\"name\":\"Ward\",\"type\":\"number\"},{\"name\":\"Police District\",\"type\":\"number\"},{\"name\":\"Community Area\",\"type\":\"number\"},{\"name\":\"LATITUDE\",\"type\":\"number\"},{\"name\":\"LONGITUDE\",\"type\":\"number\"},{\"name\":\"Location\",\"type\":\"string\"}],\"enriched\":true,\"provider\":\"bigquery\",\"tableRegion\":\"US\",\"lastModified\":1726601816252,\"originalSchema\":[{\"name\":\"SERVICE REQUEST TYPE\",\"type\":\"STRING\"},{\"name\":\"SERVICE REQUEST NUMBER\",\"type\":\"STRING\"},{\"name\":\"DATE SERVICE REQUEST WAS RECEIVED\",\"type\":\"STRING\"},{\"name\":\"LOCATION OF BUILDING ON THE LOT - IF GARAGE CHANGE TYPE CODE TO BGD-\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING DANGEROUS OR HAZARDOUS\",\"type\":\"FLOAT\"},{\"name\":\"IS BUILDING OPEN OR BOARDED\",\"type\":\"STRING\"},{\"name\":\"IF THE BUILDING IS OPEN WHERE IS THE ENTRY POINT\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING CURRENTLY VACANT OR OCCUPIED\",\"type\":\"STRING\"},{\"name\":\"IS THE BUILDING VACANT DUE TO FIRE\",\"type\":\"FLOAT\"},{\"name\":\"ANY PEOPLE USING PROPERTY - HOMELESS CHILDEN GANGS-\",\"type\":\"FLOAT\"},{\"name\":\"ADDRESS STREET NUMBER\",\"type\":\"FLOAT\"},{\"name\":\"ADDRESS STREET DIRECTION\",\"type\":\"STRING\"},{\"name\":\"ADDRESS STREET NAME\",\"type\":\"STRING\"},{\"name\":\"ADDRESS STREET SUFFIX\",\"type\":\"STRING\"},{\"name\":\"ZIP CODE\",\"type\":\"FLOAT\"},{\"name\":\"X COORDINATE\",\"type\":\"FLOAT\"},{\"name\":\"Y COORDINATE\",\"type\":\"FLOAT\"},{\"name\":\"Ward\",\"type\":\"FLOAT\"},{\"name\":\"Police District\",\"type\":\"FLOAT\"},{\"name\":\"Community Area\",\"type\":\"FLOAT\"},{\"name\":\"LATITUDE\",\"type\":\"FLOAT\"},{\"name\":\"LONGITUDE\",\"type\":\"FLOAT\"},{\"name\":\"Location\",\"type\":\"STRING\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-304,\"y\":448},\"selected\":false,\"positionAbsolute\":{\"x\":-304,\"y\":448}},{\"id\":\"fe63978b-c663-4be1-bcee-94fa88942b11\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings\",\"name\":\"ReadTable\",\"size\":158332008,\"type\":\"table\",\"label\":\"CHI_boundary_osm_buildings\",\"nrows\":813845,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"id\",\"type\":\"number\"},{\"name\":\"geom\",\"type\":\"geometry\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"geom\",\"tableRegion\":\"US\",\"lastModified\":1726675350501,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":false}],\"actionAvailable\":{\"msg\":\"<b>This table isn't optimized.</b> Creating a cluster based on geospatial data may improve performance.\",\"type\":\"createTable\",\"query\":\"CREATE TABLE {newTableName} CLUSTER BY geom AS SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings`\"}},\"originalSchema\":[{\"name\":\"id\",\"type\":\"INTEGER\"},{\"name\":\"geom\",\"type\":\"GEOGRAPHY\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-304,\"y\":656},\"selected\":false,\"positionAbsolute\":{\"x\":-304,\"y\":656}},{\"id\":\"14197a14-59bf-4e50-a0c2-19503ca4bb18\",\"data\":{\"name\":\"native.geogpoint\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"lat\",\"type\":\"Column\",\"title\":\"Latitude column\",\"parent\":\"source\",\"dataType\":[\"number\",\"string\"],\"description\":\"Latitude column\",\"value\":\"LATITUDE\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\"]},{\"name\":\"lon\",\"type\":\"Column\",\"title\":\"Longitude column\",\"parent\":\"source\",\"dataType\":[\"number\",\"string\"],\"description\":\"Longitude column\",\"value\":\"LONGITUDE\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"geom\",\"options\":[\"geom\",\"ID\",\"LATITUDE\",\"LONGITUDE\"]}],\"version\":\"1\",\"label\":\"ST GeogPoint\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":736,\"y\":368},\"selected\":false,\"positionAbsolute\":{\"x\":736,\"y\":368}},{\"id\":\"d652ae36-0ea9-46ee-815c-d726884542d0\",\"data\":{\"id\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\",\"name\":\"ReadTable\",\"size\":3731,\"type\":\"table\",\"label\":\"CHI_boundary_enriched_st_anomalies_unnested\",\"nrows\":91,\"inputs\":[{\"name\":\"source\",\"type\":\"String\",\"title\":\"Source table\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested\",\"description\":\"Read Table\"}],\"schema\":[{\"name\":\"h3\",\"type\":\"string\"},{\"name\":\"week\",\"type\":\"timestamp\"},{\"name\":\"counts\",\"type\":\"number\"},{\"name\":\"predicted_counts\",\"type\":\"number\"}],\"enriched\":true,\"provider\":\"bigquery\",\"geomField\":\"h3:h3\",\"tableRegion\":\"US\",\"lastModified\":1726736845761,\"optimization\":{\"actions\":[{\"type\":\"cluster\",\"enabled\":false}],\"actionAvailable\":{\"msg\":\"<b>This table isn't optimized.</b> Creating a cluster based on geospatial data may improve performance.\",\"type\":\"createTable\",\"query\":\"CREATE TABLE {newTableName} CLUSTER BY h3 AS SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`\"}},\"originalSchema\":[{\"name\":\"h3\",\"type\":\"STRING\"},{\"name\":\"week\",\"type\":\"DATE\"},{\"name\":\"counts\",\"type\":\"INTEGER\"},{\"name\":\"predicted_counts\",\"type\":\"INTEGER\"}]},\"type\":\"source\",\"width\":192,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":-304,\"y\":896},\"selected\":false,\"positionAbsolute\":{\"x\":-304,\"y\":896}},{\"id\":\"335e6ad2-6862-485e-9c3f-4acf8b3bed19\",\"data\":{\"name\":\"native.distance\",\"inputs\":[{\"name\":\"main\",\"type\":\"Table\",\"title\":\"Main table\",\"description\":\"Main table\"},{\"name\":\"secondary\",\"type\":\"Table\",\"title\":\"Secondary table\",\"description\":\"Secondary table\"},{\"name\":\"geomain\",\"type\":\"Column\",\"title\":\"Geo column in main table\",\"parent\":\"main\",\"dataType\":[\"geography\"],\"description\":\"Geo column in main table\",\"value\":\"geom\",\"options\":[\"geom\"]},{\"name\":\"geosecondary\",\"type\":\"Column\",\"title\":\"Geo column in secondary table\",\"parent\":\"secondary\",\"dataType\":[\"geography\"],\"description\":\"Geo column in secondary table\",\"value\":\"geom\",\"options\":[\"geom\"]},{\"name\":\"idmain\",\"type\":\"Column\",\"title\":\"Id column in main table\",\"parent\":\"main\",\"description\":\"Id column in main table\",\"value\":\"ID\",\"options\":[\"geom\",\"ID\",\"LATITUDE\",\"LONGITUDE\"]},{\"name\":\"idsecondary\",\"type\":\"Column\",\"title\":\"Id column in secondary table\",\"parent\":\"secondary\",\"description\":\"Id column in secondary table\",\"value\":\"id\",\"options\":[\"id\",\"geom\"]},{\"name\":\"radius\",\"type\":\"Number\",\"title\":\"Radius\",\"min\":0,\"description\":\"Radius\",\"value\":100},{\"name\":\"units\",\"type\":\"Selection\",\"title\":\"Units\",\"options\":[\"Meters\",\"Miles\"],\"default\":\"Meters\",\"description\":\"Units\",\"value\":\"Meters\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1\",\"label\":\"Distance to nearest\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":976,\"y\":640},\"selected\":false,\"positionAbsolute\":{\"x\":976,\"y\":640}},{\"id\":\"0e6789ec-651b-4567-8d5b-d5c6c143e8d7\",\"data\":{\"name\":\"native.select\",\"inputs\":[{\"name\":\"table\",\"type\":\"Table\",\"title\":\"Source table\",\"optional\":true,\"description\":\"Source table\"},{\"name\":\"select\",\"type\":\"StringSql\",\"title\":\"SELECT statement\",\"placeholder\":\"E.g.: *, distance_in_km * 1000 AS distance_in_meters\",\"allowExpressions\":false,\"description\":\"SELECT statement\",\"value\":\"ID, LATITUDE, LONGITUDE\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1\",\"label\":\"Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":416,\"y\":416},\"selected\":false,\"positionAbsolute\":{\"x\":416,\"y\":416}},{\"id\":\"79561f1c-5e64-4c1c-82f7-fa75ac682176\",\"data\":{\"name\":\"native.where\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"expression\",\"type\":\"StringSql\",\"title\":\"Filter expression\",\"placeholder\":\"E.g.: area > 1000 AND area < 3000\",\"description\":\"Filter expression\",\"value\":\"LATITUDE IS NOT NULL AND LONGITUDE IS NOT NULL\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"match\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\"]}],\"version\":\"1\",\"label\":\"Where\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":560,\"y\":416},\"selected\":false,\"positionAbsolute\":{\"x\":560,\"y\":416}},{\"id\":\"7746af6f-3ea9-4e43-93b5-9e99afdae2a5\",\"data\":{\"name\":\"native.selectexpression\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"String\",\"title\":\"Name for new column\",\"placeholder\":\"E.g.: distance_in_meters\",\"validation\":\"^[a-zA-Z_][a-zA-Z0-9_]*$\",\"allowExpressions\":false,\"description\":\"Name for new column\",\"value\":\"Location_ID\"},{\"name\":\"expression\",\"type\":\"StringSql\",\"title\":\"Expression\",\"placeholder\":\"E.g.: distance_in_km * 1000\",\"description\":\"Expression\",\"value\":\"ROW_NUMBER() OVER(PARTITION BY Location)\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"SERVICE_REQUEST_TYPE\",\"SERVICE_REQUEST_NUMBER\",\"DATE_SERVICE_REQUEST_WAS_RECEIVED\",\"LOCATION_OF_BUILDING_ON_THE_LOT_IF_GARAGE_CHANGE_TYPE_CODE_TO_BGD_\",\"IS_THE_BUILDING_DANGEROUS_OR_HAZARDOUS\",\"IS_BUILDING_OPEN_OR_BOARDED\",\"IF_THE_BUILDING_IS_OPEN_WHERE_IS_THE_ENTRY_POINT\",\"IS_THE_BUILDING_CURRENTLY_VACANT_OR_OCCUPIED\",\"IS_THE_BUILDING_VACANT_DUE_TO_FIRE\",\"ANY_PEOPLE_USING_PROPERTY_HOMELESS_CHILDEN_GANGS_\",\"ADDRESS_STREET_NUMBER\",\"ADDRESS_STREET_DIRECTION\",\"ADDRESS_STREET_NAME\",\"ADDRESS_STREET_SUFFIX\",\"ZIP_CODE\",\"X_COORDINATE\",\"Y_COORDINATE\",\"Ward\",\"Police_District\",\"Community_Area\",\"LATITUDE\",\"LONGITUDE\",\"Location\",\"ID\",\"Location_ID\"]}],\"version\":\"1\",\"label\":\"Create Column\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":96,\"y\":448},\"selected\":false,\"positionAbsolute\":{\"x\":96,\"y\":448}},{\"id\":\"1e310368-3313-4d5a-a086-de1417a1077f\",\"data\":{\"name\":\"native.wheresimplified\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column\",\"parent\":\"source\",\"dataType\":[\"string\",\"number\",\"date\",\"datetime\",\"time\",\"timestamp\",\"boolean\"],\"description\":\"Column\",\"value\":\"Location_ID\",\"options\":[\"SERVICE_REQUEST_TYPE\",\"SERVICE_REQUEST_NUMBER\",\"DATE_SERVICE_REQUEST_WAS_RECEIVED\",\"LOCATION_OF_BUILDING_ON_THE_LOT_IF_GARAGE_CHANGE_TYPE_CODE_TO_BGD_\",\"IS_THE_BUILDING_DANGEROUS_OR_HAZARDOUS\",\"IS_BUILDING_OPEN_OR_BOARDED\",\"IF_THE_BUILDING_IS_OPEN_WHERE_IS_THE_ENTRY_POINT\",\"IS_THE_BUILDING_CURRENTLY_VACANT_OR_OCCUPIED\",\"IS_THE_BUILDING_VACANT_DUE_TO_FIRE\",\"ANY_PEOPLE_USING_PROPERTY_HOMELESS_CHILDEN_GANGS_\",\"ADDRESS_STREET_NUMBER\",\"ADDRESS_STREET_DIRECTION\",\"ADDRESS_STREET_NAME\",\"ADDRESS_STREET_SUFFIX\",\"ZIP_CODE\",\"X_COORDINATE\",\"Y_COORDINATE\",\"Ward\",\"Police_District\",\"Community_Area\",\"LATITUDE\",\"LONGITUDE\",\"Location\",\"ID\",\"Location_ID\"]},{\"name\":\"operator\",\"type\":\"Selection\",\"title\":\"Operator\",\"options\":[\"equal to\",\"not equal\",\"less than\",\"greater than\",\"equal or less than\",\"equal or greater than\"],\"description\":\"Operator\",\"value\":\"equal to\"},{\"name\":\"value\",\"type\":\"String\",\"title\":\"Value\",\"description\":\"Value\",\"value\":\"1\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"match\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"options\":[\"SERVICE_REQUEST_TYPE\",\"SERVICE_REQUEST_NUMBER\",\"DATE_SERVICE_REQUEST_WAS_RECEIVED\",\"LOCATION_OF_BUILDING_ON_THE_LOT_IF_GARAGE_CHANGE_TYPE_CODE_TO_BGD_\",\"IS_THE_BUILDING_DANGEROUS_OR_HAZARDOUS\",\"IS_BUILDING_OPEN_OR_BOARDED\",\"IF_THE_BUILDING_IS_OPEN_WHERE_IS_THE_ENTRY_POINT\",\"IS_THE_BUILDING_CURRENTLY_VACANT_OR_OCCUPIED\",\"IS_THE_BUILDING_VACANT_DUE_TO_FIRE\",\"ANY_PEOPLE_USING_PROPERTY_HOMELESS_CHILDEN_GANGS_\",\"ADDRESS_STREET_NUMBER\",\"ADDRESS_STREET_DIRECTION\",\"ADDRESS_STREET_NAME\",\"ADDRESS_STREET_SUFFIX\",\"ZIP_CODE\",\"X_COORDINATE\",\"Y_COORDINATE\",\"Ward\",\"Police_District\",\"Community_Area\",\"LATITUDE\",\"LONGITUDE\",\"Location\",\"ID\",\"Location_ID\"]}],\"version\":\"1\",\"label\":\"Simple Filter\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":256,\"y\":448},\"selected\":false,\"positionAbsolute\":{\"x\":256,\"y\":448}},{\"id\":\"61b36200-c5bb-40a6-8009-f34cd7a7c0b1\",\"data\":{\"name\":\"native.join\",\"inputs\":[{\"name\":\"maintable\",\"type\":\"Table\",\"title\":\"Main table\",\"description\":\"Main table\"},{\"name\":\"secondarytable\",\"type\":\"Table\",\"title\":\"Secondary table\",\"description\":\"Secondary table\"},{\"name\":\"maincolumn\",\"type\":\"Column\",\"title\":\"Column in main table\",\"parent\":\"maintable\",\"dataType\":[\"boolean\",\"date\",\"datetime\",\"time\",\"timestamp\",\"number\",\"string\"],\"description\":\"Column in main table\",\"value\":\"nearest_id\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\",\"nearest_id\",\"nearest_distance\"]},{\"name\":\"secondarycolumn\",\"type\":\"Column\",\"title\":\"Column in secondary table\",\"parent\":\"secondarytable\",\"dataType\":[\"boolean\",\"date\",\"datetime\",\"time\",\"timestamp\",\"number\",\"string\"],\"description\":\"Column in secondary table\",\"value\":\"id\",\"options\":[\"id\"]},{\"name\":\"jointype\",\"type\":\"Selection\",\"title\":\"Join type\",\"options\":[\"Inner\",\"Left\",\"Right\",\"Full outer\"],\"default\":\"Inner\",\"description\":\"Join type\",\"value\":\"Inner\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"1.2\",\"label\":\"Join\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1216,\"y\":848},\"selected\":false,\"positionAbsolute\":{\"x\":1216,\"y\":848}},{\"id\":\"95bdb371-bbb7-4021-8c87-9564c7140da8\",\"data\":{\"name\":\"native.dropcolumn\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Columns to drop\",\"parent\":\"source\",\"mode\":\"multiple\",\"noDefault\":true,\"description\":\"Columns to drop\",\"value\":[\"id_joined\",\"geom\"],\"options\":[\"geom\",\"ID\",\"LATITUDE\",\"LONGITUDE\",\"nearest_id\",\"nearest_distance\",\"id_joined\",\"geom_joined\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"geom_joined\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\",\"nearest_id\",\"nearest_distance\",\"geom_joined\"]}],\"version\":\"1\",\"label\":\"Drop Columns\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1376,\"y\":848},\"selected\":false,\"positionAbsolute\":{\"x\":1376,\"y\":848}},{\"id\":\"18276d66-d586-4b76-ac47-e602b3885d3b\",\"data\":{\"name\":\"native.renamecolumn\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"column\",\"type\":\"Column\",\"title\":\"Column to rename\",\"parent\":\"source\",\"dataType\":[\"boolean\",\"geography\",\"number\",\"string\"],\"description\":\"Column to rename\",\"value\":\"geom_joined\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\",\"nearest_id\",\"nearest_distance\",\"geom_joined\"]},{\"name\":\"newname\",\"type\":\"String\",\"title\":\"New column name\",\"validation\":\"^[a-zA-Z_][a-zA-Z0-9_]*$\",\"allowExpressions\":false,\"description\":\"New column name\",\"value\":\"geom\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"geom\",\"options\":[\"ID\",\"LATITUDE\",\"LONGITUDE\",\"nearest_id\",\"nearest_distance\",\"geom\"]}],\"version\":\"1\",\"label\":\"Rename Column\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1568,\"y\":848},\"selected\":false,\"positionAbsolute\":{\"x\":1568,\"y\":848}},{\"id\":\"fcad1fdd-af00-46ae-8ab8-dcd023780dff\",\"data\":{\"name\":\"native.customsql\",\"inputs\":[{\"name\":\"sourcea\",\"type\":\"Table\",\"title\":\"Source table a\",\"optional\":true,\"description\":\"Source table a\"},{\"name\":\"sourceb\",\"type\":\"Table\",\"title\":\"Source table b\",\"optional\":true,\"description\":\"Source table b\"},{\"name\":\"sourcec\",\"type\":\"Table\",\"title\":\"Source table c\",\"optional\":true,\"description\":\"Source table c\"},{\"name\":\"sql\",\"type\":\"StringSql\",\"title\":\"SQL SELECT statement\",\"mode\":\"multiline\",\"placeholder\":\"SELECT ST_Centroid(geom) AS geom,\\n  AVG(value) AS average_value,\\n  category\\nFROM $a\\nGROUP BY category\",\"allowExpressions\":false,\"description\":\"SQL SELECT statement\",\"value\":\"SELECT a.geom\\nFROM `$a`a\\nJOIN `$b`b\\nON ST_INTERSECTS(b.h3_geo, a.geom)\"},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\"}],\"version\":\"2.0.0\",\"label\":\"Custom SQL Select\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":1760,\"y\":864},\"selected\":false,\"positionAbsolute\":{\"x\":1760,\"y\":864}},{\"id\":\"5061c491-312a-4100-a2ac-c8d65bab634e\",\"data\":{\"name\":\"native.h3boundary\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"h3col\",\"type\":\"Column\",\"title\":\"H3 column\",\"parent\":\"source\",\"placeholder\":\"h3\",\"dataType\":[\"string\"],\"description\":\"H3 column\",\"value\":\"h3\",\"options\":[\"h3\"]},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"h3_geo\",\"options\":[\"h3_geo\",\"h3\",\"week\",\"counts\",\"predicted_counts\"]}],\"version\":\"1\",\"label\":\"H3 Boundary\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":112,\"y\":896},\"selected\":false,\"positionAbsolute\":{\"x\":112,\"y\":896}},{\"id\":\"a6bd614b-be85-4c52-b230-9199ad01fcee\",\"data\":{\"name\":\"native.saveastable\",\"inputs\":[{\"name\":\"source\",\"type\":\"Table\",\"title\":\"Source table\",\"description\":\"Source table\"},{\"name\":\"destination\",\"type\":\"OutputTable\",\"title\":\"Table details\",\"placeholder\":\"Rename and select destination\",\"description\":\"Table details\",\"value\":\"cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings\"},{\"name\":\"append\",\"type\":\"Boolean\",\"title\":\"Append to existing table\",\"default\":false,\"description\":\"Append to existing table\",\"value\":false},{\"name\":\"optimizationcol\",\"type\":\"Column\",\"title\":\"Cluster by\",\"parent\":\"source\",\"parentOutput\":\"result\",\"dataType\":[\"geography\",\"boolean\",\"number\",\"string\",\"date\",\"datetime\",\"time\",\"timestamp\"],\"providers\":[\"bigquery\"],\"optional\":true,\"advanced\":true,\"description\":\"Cluster by\",\"value\":\"geom\",\"options\":[\"geom\"]}],\"version\":\"1\",\"label\":\"Save as Table\"},\"type\":\"generic\",\"width\":64,\"height\":64,\"zIndex\":2,\"dragging\":false,\"position\":{\"x\":2048,\"y\":864},\"selected\":false,\"positionAbsolute\":{\"x\":2048,\"y\":864}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":623.9929999999999,\"height\":735.9979999999999,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Input data\",\"position\":{\"x\":-656.001,\"y\":287.994}},\"type\":\"note\",\"width\":624,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-656,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":-656,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":591.9929999999999,\"height\":191.998,\"inputs\":[],\"markdown\":\"---\\nlabel: Anomalous space-time region\\n---\\n##\",\"position\":{\"x\":-640.009,\"y\":800}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-640,\"y\":800},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":800}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889-1726833430111\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":591.999,\"height\":191.994,\"inputs\":[],\"markdown\":\"---\\nlabel: OSM buildings\\n---\\n##\",\"position\":{\"x\":-640.007,\"y\":576}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-640,\"y\":576},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":576}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833346889-1726833430111-1726833449150\",\"data\":{\"name\":\"Note\",\"color\":\"#8BE0A4\",\"genAi\":false,\"label\":\"\",\"width\":591.999,\"height\":191.994,\"inputs\":[],\"markdown\":\"---\\nlabel: 311  vacant buildings 2001 - 2017\\n---\\n311 calls for open and vacant buildings [reported](https://www.chicago.gov/city/en/depts/bldgs/dataset/vacant_and_abandonedbuildingsservicerequests.html ) to the City of Chicago between January 1, 2010 and December 2018.\",\"position\":{\"x\":-640.007,\"y\":368}},\"type\":\"note\",\"width\":592,\"height\":192,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-640,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":-640,\"y\":352}},{\"id\":\"251263f0-60ba-4468-b2da-caa0155aeef4\",\"data\":{\"name\":\"Note\",\"color\":\"#FE88B1\",\"genAi\":false,\"label\":\"\",\"width\":335.99600000000004,\"height\":735.997,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Save results to a table\",\"position\":{\"x\":1904,\"y\":288}},\"type\":\"note\",\"width\":448,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":1904,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":1904,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1903.99,\"height\":735.9939999999999,\"inputs\":[],\"markdown\":\"---\\nlabel:\\n---\\n## Join data sources\",\"position\":{\"x\":-16,\"y\":288}},\"type\":\"note\",\"width\":1904,\"height\":736,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":-16,\"y\":288},\"selected\":false,\"positionAbsolute\":{\"x\":-16,\"y\":288}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186-1726835244460\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1087.99,\"height\":399.994,\"inputs\":[],\"markdown\":\"---\\nlabel: Extract point geometries and find. the nearest building (within 100 m)\\n---\",\"position\":{\"x\":0,\"y\":351.994}},\"type\":\"note\",\"width\":1088,\"height\":400,\"zIndex\":-1,\"dragging\":true,\"position\":{\"x\":0,\"y\":352},\"selected\":false,\"positionAbsolute\":{\"x\":0,\"y\":352}},{\"id\":\"7f13c70e-c483-4004-8a64-860ee072bd80-1726833822186-1726835244460-1726835578127\",\"data\":{\"name\":\"Note\",\"color\":\"#F89C74\",\"genAi\":false,\"label\":\"\",\"width\":1871.99,\"height\":239.998,\"inputs\":[],\"markdown\":\"---\\nlabel: Find the vacant properties within the detected anomalous region\\n---\",\"position\":{\"x\":0,\"y\":768}},\"type\":\"note\",\"width\":1872,\"height\":240,\"zIndex\":-1,\"dragging\":false,\"position\":{\"x\":0,\"y\":768},\"selected\":false,\"positionAbsolute\":{\"x\":0,\"y\":768}}],\"title\":\"(9/) SDSC - Unlocking Smarter Property Risk Assessments with Spatio-Temporal Crime Insights and CARTO\",\"useCache\":false,\"viewport\":{\"x\":306.3565229473184,\"y\":-57.52935768023201,\"zoom\":0.45947934199881474},\"description\":\"\",\"thumbnailUrl\":\"\",\"schemaVersion\":\"1.0.0\",\"connectionProvider\":\"bigquery\"}"}
  */
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_3cb5ae20bca68cd5_result`
  AS
    SELECT *,
      ROW_NUMBER() OVER(PARTITION BY Location) AS Location_ID
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_311_vacant_buildings`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_65656aad51476875_match`
  AS
    SELECT *
    FROM `WORKFLOW_9399426d2a33e433_3cb5ae20bca68cd5_result`
    WHERE
      Location_ID = 1;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_37e778417ba47da3_result`
  AS
    SELECT ID, LATITUDE, LONGITUDE
    FROM `WORKFLOW_9399426d2a33e433_65656aad51476875_match`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_706ffa79ad0d0721_match`
  AS
    SELECT *
    FROM `WORKFLOW_9399426d2a33e433_37e778417ba47da3_result`
    WHERE LATITUDE IS NOT NULL AND LONGITUDE IS NOT NULL;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_1ffee075ca3822d8_result`
  CLUSTER BY geom
  AS
    SELECT ST_GEOGPOINT(
      CAST(LONGITUDE as FLOAT64),
      CAST(LATITUDE as FLOAT64)
    ) AS  geom, *
    FROM `WORKFLOW_9399426d2a33e433_706ffa79ad0d0721_match`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_d3e4cf94290be88a_result`
  AS
    WITH nearest AS (
      SELECT a.ID AS main_id,
          ARRAY_AGG(
              STRUCT(
                  b.id AS nearest_id,
                  ST_DISTANCE(
                      a.geom,
                      b.geom
                  ) AS nearest_distance
              )
              ORDER BY ST_DISTANCE(
                      a.geom,
                      b.geom
                  )
              LIMIT 1
          ) [ORDINAL(1)] AS nearest
      FROM `WORKFLOW_9399426d2a33e433_1ffee075ca3822d8_result` a
          JOIN `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings` b
            ON ST_DWITHIN(
              a.geom,
              b.geom,
              100 
            )
      GROUP BY a.ID
    )
    SELECT a.*,
        n.nearest.nearest_id AS nearest_id,
        n.nearest.nearest_distance  AS nearest_distance
    FROM nearest n
        JOIN `WORKFLOW_9399426d2a33e433_1ffee075ca3822d8_result` a
          ON a.ID = n.main_id;
  END;
  BEGIN
  DECLARE alias STRING;
  CREATE TABLE `cartodb-on-gcp-datascience.workflows_temp.table_48704762_e446_4d45_911e_c36bc013404c` AS
  SELECT * FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings`
  WHERE 1=0;
  EXECUTE IMMEDIATE
  '''
    with __alias AS(
      SELECT CONCAT(
        '_joined.', column_name, ' AS ', column_name, '_joined'
      ) col_alias
      FROM `cartodb-on-gcp-datascience.workflows_temp`.INFORMATION_SCHEMA.COLUMNS
    WHERE table_name = 'table_48704762_e446_4d45_911e_c36bc013404c'
    )
    SELECT STRING_AGG(col_alias, ', ')
    FROM __alias
  '''
  INTO alias;
  DROP TABLE `cartodb-on-gcp-datascience.workflows_temp.table_48704762_e446_4d45_911e_c36bc013404c`;
  EXECUTE IMMEDIATE
  REPLACE(
    '''CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_12c5b044720da2cf_result`
    AS
      SELECT
        _main.*,
        %s
      FROM
        `WORKFLOW_9399426d2a33e433_d3e4cf94290be88a_result` AS _main
        INNER JOIN
        `cartobq.sdsc24_ny_workshops.CHI_boundary_osm_buildings` AS _joined
      ON
        _main.nearest_id = _joined.id''',
    '%s',
    alias
  );
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_aff6483149bf1a83_result`
  CLUSTER BY geom_joined
  AS
    SELECT * EXCEPT (id_joined, geom)
    FROM `WORKFLOW_9399426d2a33e433_12c5b044720da2cf_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_3e55d2026fa53406_result`
  CLUSTER BY geom
  AS
    SELECT * EXCEPT (geom_joined),
      geom_joined AS geom
    FROM `WORKFLOW_9399426d2a33e433_aff6483149bf1a83_result`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_07989689e40ad423_result`
  CLUSTER BY h3_geo
  AS
    SELECT
      `carto-un.carto`.H3_BOUNDARY(
          h3
      ) h3_geo, *
    FROM `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested`;
  END;
  BEGIN
  CREATE TEMPORARY TABLE `WORKFLOW_9399426d2a33e433_dec532cd93a724bf_result`
  AS
    SELECT a.geom
    FROM `WORKFLOW_9399426d2a33e433_3e55d2026fa53406_result`a
    JOIN `WORKFLOW_9399426d2a33e433_07989689e40ad423_result`b
    ON ST_INTERSECTS(b.h3_geo, a.geom);
  END;
  BEGIN
  DROP TABLE IF EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings`;
  CREATE TABLE IF NOT EXISTS `cartobq.sdsc24_ny_workshops.CHI_boundary_enriched_st_anomalies_unnested_w_vacant_buildings`
  CLUSTER BY geom
  AS
    SELECT * FROM `WORKFLOW_9399426d2a33e433_dec532cd93a724bf_result`;
  END;
END;